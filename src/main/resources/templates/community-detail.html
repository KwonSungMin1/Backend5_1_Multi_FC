<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²Œì‹œê¸€ ìƒì„¸ (' + ${postId} + ') - FUTSAL MATCH'">FUTSAL MATCH - ê²Œì‹œê¸€ ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .community-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .board-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .detail-header {
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .detail-header h1 {
            font-size: 26px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .detail-meta {
            font-size: 14px;
            color: #777;
        }
        .detail-meta span:not(:last-child)::after {
            content: " | ";
            color: #ccc;
        }

        .detail-content {
            min-height: 200px;
            padding: 20px 0;
            line-height: 1.6;
            font-size: 16px;
            color: #333;
            border-bottom: 1px solid #eee;
        }

        /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
        .post-actions {
            display: flex;
            justify-content: space-between; /* â­â­ ëª©ë¡ ë²„íŠ¼ì„ ì™¼ìª½ ë, ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ ëì— ë°°ì¹˜ â­â­ */
            align-items: center;
            margin-top: 15px;
        }
        .detail-controls button, .detail-controls a {
            padding: 8px 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            margin-left: 5px;
            border: 1px solid #ddd;
        }
        /* ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-edit { background-color: #4a90e2; color: white; border: none; }
        .btn-delete { background-color: #e74c3c; color: white; border: none; }

        /* â­â­ ëŒ“ê¸€ ì„¹ì…˜ ìƒë‹¨ ë§ˆì§„ ì¡°ì • â­â­ */
        .comments-section {
            margin-top: 35px; /* ì—¬ë°± í™•ë³´ */
        }
        .comment-item {
            border-bottom: 1px dotted #ddd;
            padding: 15px 0;
            font-size: 15px;
            position: relative; /* ë‹µê¸€ ë²„íŠ¼ ìœ„ì¹˜ ì§€ì •ìš© */
        }
        /* ëŒ“ê¸€ í—¤ë” ë° ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
        .comment-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .comment-meta {
            display: flex;
            font-size: 13px;
            color: #999;
            gap: 15px;
        }
        .comment-writer {
            font-weight: 700;
            color: #6c5ce7;
            margin-right: 10px;
        }
        .comment-date {
            font-size: 13px;
            color: #999;
        }
        .comment-content {
            color: #333;
            line-height: 1.5;
            margin-left: 0;
        }
        /* â­â­ ëŒ“ê¸€ ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ â­â­ */
        .comment-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .comment-actions button {
            background: none;
            border: none;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            transition: color 0.2s;
            font-weight: 500;
        }
        .comment-actions button:hover {
            color: #4a90e2;
        }
        .comment-actions .delete {
            color: #e74c3c;
        }
        .comment-actions .reply {
            color: #2ecc71;
            font-weight: 600;
        }
        /* â­â­ ëŒ€ëŒ“ê¸€ ì‹œê°ì  êµ¬ë¶„ â­â­ */
        .comment-item.reply {
            margin-left: 30px; /* ë“¤ì—¬ì“°ê¸° */
            border-left: 3px solid #f0f0f0; /* ì‹œê°ì  êµ¬ë¶„ì„  */
            padding-left: 10px;
            margin-bottom: 5px;
        }
        /* â­â­ ëŒ€ëŒ“ê¸€ í¼ ìŠ¤íƒ€ì¼ â­â­ */
        .reply-form-container {
            margin-top: 10px;
            padding: 15px;
            background: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-left: 20px;
        }
        .reply-form-container textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .reply-form-container button {
            float: right;
            padding: 8px 15px;
            font-size: 14px;
            margin-left: 10px;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .reply-form-container .btn-reply-cancel {
            background-color: #aaa;
            color: white;
            border: none;
        }
        .reply-form-container::after {
            content: "";
            display: table;
            clear: both;
        }
        /* â­â­ ëŒ“ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ ë â­â­ */
        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            margin-bottom: 10px;
        }
        .comment-form button {
            float: right;
            padding: 10px 18px;
            background-color: #6c5ce7;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 5px;
        }
        .comment-form::after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info"> <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong> <p>í™˜ì˜í•©ë‹ˆë‹¤!</p> </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community" class="active"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/schedule"><i class="fas fa-calendar-alt"></i> ì¼ì •</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="board-container">

        <div class="detail-header">
            <h1 id="post-title"></h1>
            <div class="detail-meta">
                <span id="detail-writer"></span>
                <span id="detail-date"></span>
                <span id="detail-views"></span>
                <span id="detail-comments"></span>
            </div>
        </div>

        <div class="detail-content" id="post-content">
        </div>

        <div class="post-actions">

            <div class="detail-controls">
                <a href="/community" class="btn-list" style="background-color: #f0f0f0; color: #555;">ëª©ë¡ìœ¼ë¡œ</a>
            </div>

            <div class="detail-controls" id="author-controls">
                <button class="btn-edit" id="btn-edit-post" style="display: none; background-color: #4a90e2; color: white;">ìˆ˜ì •</button>
                <button class="btn-delete" id="btn-delete-post" style="display: none; background-color: #e74c3c; color: white;">ì‚­ì œ</button>
            </div>
        </div>

        <div class="comments-section">
            <h3 style="font-size: 20px; color: #2c3e50; margin-bottom: 15px;">ëŒ“ê¸€ (<span id="comment-count">0</span>)</h3>

            <div class="comment-form">
                <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <button onclick="submitComment()">ë“±ë¡</button>
                <div style="clear: both;"></div>
            </div>

            <div id="comments-list">
            </div>
        </div>
    </div>
</main>

<script>
    // â­â­ MOCK_POSTS ë”ë¯¸ ê²Œì‹œê¸€ ë°ì´í„° (ë¡œì»¬ ì €ì¥ì†Œ í†µí•©ì„ ìœ„í•´ MOCK_POSTS ëŒ€ì‹  loadAvailablePosts ì‚¬ìš©) â­â­
    const initialMocks = [
        { postId: 10, title: '[í•„ë…] ê³µì§€ì‚¬í•­ ë° ë§¤ë„ˆ ì ìˆ˜ ì•ˆë‚´', writer: 'ê´€ë¦¬ì', writerId: 1000, content: 'ì•ˆë…•í•˜ì„¸ìš”. FUTSAL MATCHì…ë‹ˆë‹¤. ì›í™œí•˜ê³  ê³µì •í•œ ê²½ê¸° ë§¤ì¹­ì„ ìœ„í•´ ë§¤ë„ˆ ì ìˆ˜(Manner Score) ì‹œìŠ¤í…œì„ ë‹¤ìŒê³¼ ê°™ì´ ê°œí¸í•©ë‹ˆë‹¤. ëª¨ë“  ì‚¬ìš©ìëŠ” ë³€ê²½ëœ ê·œì •ì„ ìˆ™ì§€í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. - ë³€ê²½ ì‚¬í•­ ìš”ì•½ - 1. ê²½ê¸° ì¢…ë£Œ í›„ ì˜ë¬´ì ìœ¼ë¡œ íŒ€ì› í‰ê°€ë¥¼ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. 2. í‰ê°€ ë¯¸ì°¸ì—¬ì‹œ ë‹¤ìŒ ê²½ê¸° ë§¤ì¹­ì— ë¶ˆì´ìµì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', category: 'notice', date: '2025-10-25', viewCount: 1200, comments: [
                { id: 1, writer: 'UserA', writerId: 1001, date: '2025-10-25', content: 'ìš´ì˜ì§„ë‹˜, ë§¤ë„ˆ ì‹œìŠ¤í…œ ë„ì… ì°¬ì„±í•©ë‹ˆë‹¤! ê¸°ëŒ€ë¼ìš”.', parentCommentId: null, writerId: 1001 },
                { id: 2, writer: 'UserB', writerId: 1002, date: '2025-10-26', content: 'ì¢‹ì€ ì·¨ì§€ì¸ë°, í‰ê°€ê°€ ë„ˆë¬´ ì£¼ê´€ì ì´ì§€ ì•Šë„ë¡ ê´€ë¦¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.', parentCommentId: null, writerId: 1002 },
                { id: 3, writer: 'ê´€ë¦¬ì', writerId: 1000, date: '2025-11-06', content: 'ëŒ“ê¸€ ì‘ì„± í…ŒìŠ¤íŠ¸.', parentCommentId: null, writerId: 1000 },
                { id: 4, writer: 'ê´€ë¦¬ì', writerId: 1000, date: '2025-11-06', content: '@UserB ë‹µê¸€ í…ŒìŠ¤íŠ¸.', parentCommentId: 2, writerId: 1000 } // ëŒ€ëŒ“ê¸€ ì‹œë®¬ë ˆì´ì…˜ (UserBì—ê²Œ ë‹µê¸€)
            ] },
        { postId: 11, title: 'ììœ ê²Œì‹œíŒì—ì„œ ì‘ì„±ëœ ê¸€ì…ë‹ˆë‹¤.', writer: 'UserB', writerId: 1001, content: 'ì´ê²ƒì´ ììœ ê²Œì‹œíŒì˜ ê¸€ ë‚´ìš©ì…ë‹ˆë‹¤!', category: 'free', date: '2025-11-01', viewCount: 50, comments: [{ id: 5, writer: 'UserC', writerId: 1003, date: '2025-11-01', content: 'ììœ ê¸€ ëŒ“ê¸€.', parentCommentId: null, writerId: 1003 }] },
        { postId: 12, title: 'íŒ€ì› ëª¨ì§‘í•©ë‹ˆë‹¤!', writer: 'ìº¡í‹´ì†', writerId: 1002, content: 'íŒ€ì› ëª¨ì§‘ ë‚´ìš©', category: 'team', date: '2025-11-02', viewCount: 20, comments: [] },
    ];
    let POST_DATA = null;
    let ALL_AVAILABLE_POSTS = []; // í†µí•©ëœ ëª¨ë“  ê²Œì‹œê¸€ ëª©ë¡

    const CURRENT_USER_ID = 999; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID ê°€ì •
    // â­â­â­ [ìˆ˜ì •] ë¡œê·¸ì¸ ì‚¬ìš©ì ë‹‰ë„¤ì„ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½ â­â­â­
    const CURRENT_USER_WRITER_NAME = localStorage.getItem('userNickname') || 'ë¡œê·¸ì¸ ì‚¬ìš©ì';

    /**
     * ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ MOCK ë°ì´í„°ë¥¼ í†µí•©í•˜ì—¬ ëª¨ë“  ê²Œì‹œê¸€ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    function loadAllAvailablePosts(targetPostId) {
        let localPostsRaw = [];
        try {
            const storedData = localStorage.getItem('community_posts');
            if (storedData) {
                localPostsRaw = JSON.parse(storedData);
            }
        } catch (e) {
            console.error("Local Storage data corrupted, attempting recovery.", e);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œì»¬ ì €ì¥ì†Œ ì´ˆê¸°í™” ì‹œë„
            // localStorage.removeItem('community_posts'); // ì£¼ì„ ì²˜ë¦¬: ë°ì´í„°ê°€ ë‚¨ì•„ìˆë„ë¡
            localPostsRaw = [];
        }

        const localPosts = localPostsRaw.map(post => ({
            ...post,
            postId: parseInt(post.id),
            id: String(post.id),
            comments: post.comments || [],
            commentCount: post.commentCount || 0,
            viewCount: post.viewCount || 0,
            writerId: post.writerId || 999
        }));

        // MOCK ë°ì´í„°ë¥¼ ì •ê·œí™”í•˜ê³  IDë¥¼ ë¬¸ìì—´ë¡œ ìœ ì§€
        const mockPosts = initialMocks.map(post => ({
            ...post,
            postId: post.postId,
            id: String(post.postId),
            writerId: post.writerId
        }));


        const combinedPosts = [...localPosts];

        // MOCK ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©°, ë¡œì»¬ í¬ìŠ¤íŠ¸ì— IDê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€í•©ë‹ˆë‹¤.
        mockPosts.forEach(mockPost => {
            if (!localPosts.some(p => String(p.id) === String(mockPost.id))) {
                combinedPosts.push(mockPost);
            }
        });

        ALL_AVAILABLE_POSTS = combinedPosts;

        // íŠ¹ì • ê²Œì‹œê¸€ì„ ì°¾ì•„ì„œ ë°˜í™˜í•©ë‹ˆë‹¤.
        return ALL_AVAILABLE_POSTS.find(p => String(p.id) === String(targetPostId));
    }


    // --- DOM ë¡œë“œ ë° ì´ˆê¸°í™” ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë° ì¸ì¦ ë¡œì§ ì‹œì‘ ---
        const menuToggle = document.getElementById('menu-toggle');
        const mainMenu = document.getElementById('main-menu');
        const profileMenuToggle = document.getElementById('profile-menu-toggle');
        const profileMenu = document.getElementById('profile-menu');

        // â­â­ ì•Œë¦¼ ë°°ì§€ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ (Mock) â­â­
        const badge = document.getElementById('notification-badge');
        let hasReviewNotif = false;
        let hasScheduleNotif = false;

        function updateGlobalBadge() {
            if (badge) {
                badge.style.display = (hasReviewNotif || hasScheduleNotif) ? 'block' : 'none';
            }
        }
        async function checkPendingReviews() {
            if (localStorage.getItem('hasReadReviews') === 'true') {
                hasReviewNotif = false;
                return;
            }
            const mockReviews = { "count": 1 };
            if (mockReviews.count > 0) {
                hasReviewNotif = true;
            }
        }
        async function checkUpcomingSchedules() {
            hasScheduleNotif = localStorage.getItem('hasReadSchedules') !== 'true';
        }
        // â­â­ ì•Œë¦¼ ë°°ì§€ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ ë â­â­


        if (menuToggle) {
            menuToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                mainMenu.classList.toggle('show');
                if(profileMenu) profileMenu.classList.remove('show');
            });
        }
        if (profileMenuToggle) {
            profileMenuToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                if(profileMenu) profileMenu.classList.toggle('show');
                if(mainMenu) mainMenu.classList.remove('show');
            });
        }
        // ... (ë‚˜ë¨¸ì§€ ê³µí†µ ë¡œì§ ìœ ì§€) ...

        // â­â­ í—¤ë” ë‹‰ë„¤ì„ ë¡œë“œ ë° ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸ â­â­
        const userMenuName = document.getElementById('user-menu-username');
        const accessToken = localStorage.getItem('accessToken');

        if (accessToken) {
            if (profileMenuToggle) profileMenuToggle.style.display = 'flex';
            if (userMenuName) userMenuName.textContent = CURRENT_USER_WRITER_NAME;

            (async () => {
                await checkPendingReviews();
                await checkUpcomingSchedules();
                updateGlobalBadge();
            })();
        }


        // â­â­ URLì—ì„œ postIdë¥¼ ê°€ì ¸ì™€ loadPostDetail í•¨ìˆ˜ì— ì „ë‹¬ â­â­
        const urlParams = new URLSearchParams(window.location.search);
        const postIdFromParam = urlParams.get('postId');

        const pathSegments = window.location.pathname.split('/');
        const postIdFromPath = pathSegments.pop() || pathSegments.pop();

        // IDê°€ ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš°ë§Œ loadPostDetail í˜¸ì¶œ, ì•„ë‹ˆë©´ ê¸°ë³¸ê°’ 10(ê³µì§€) ë¡œë“œ
        const targetPostId = postIdFromParam || (postIdFromPath && !isNaN(parseInt(postIdFromPath)) ? String(parseInt(postIdFromPath)) : '10');

        loadPostDetail(targetPostId);
    });

    function loadPostDetail(postId) {
        // 1. ëª¨ë“  ê²Œì‹œê¸€ì„ í†µí•©í•˜ê³  íŠ¹ì • ê²Œì‹œê¸€ì„ ì°¾ìŠµë‹ˆë‹¤.
        const post = loadAllAvailablePosts(postId);
        window.POST_DATA = post;

        if (!post) {
            document.getElementById('post-title').textContent = 'ì˜¤ë¥˜: ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            document.querySelector('.detail-header').style.display = 'none';
            document.getElementById('post-content').textContent = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì…ë‹ˆë‹¤.';
            return;
        }

        // 2. DOM ì—…ë°ì´íŠ¸
        document.getElementById('post-title').textContent = post.title;
        document.getElementById('detail-writer').textContent = `ì‘ì„±ì: ${post.writer}`;
        document.getElementById('detail-date').textContent = post.date;
        document.getElementById('detail-views').textContent = `ì¡°íšŒ: ${post.viewCount || 0}`;
        document.getElementById('detail-comments').textContent = `ëŒ“ê¸€: ${post.comments ? post.comments.length : 0}`;
        document.getElementById('post-content').innerHTML = post.content ? post.content.replace(/\n/g, '<br>') : 'ë‚´ìš© ì—†ìŒ';
        document.getElementById('comment-count').textContent = post.comments ? post.comments.length : 0;

        // 3. ê¶Œí•œ ì²´í¬ ë° ë²„íŠ¼ í‘œì‹œ
        const editBtn = document.getElementById('btn-edit-post');
        const deleteBtn = document.getElementById('btn-delete-post');

        if (String(post.writerId) === String(CURRENT_USER_ID)) { // ID ë¹„êµ ì‹œ ì•ˆì „í•˜ê²Œ ë¬¸ìì—´ ë³€í™˜
            // ì‘ì„±ìê°€ í˜„ì¬ ìœ ì €ì¸ ê²½ìš°, ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì„ í‘œì‹œ
            if (editBtn) {
                editBtn.style.display = 'inline-block';
                editBtn.onclick = handleEditPost;
            }
            if (deleteBtn) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = handleDeletePost;
            }
        } else {
            // ì‘ì„±ìê°€ ì•„ë‹ ê²½ìš°, ë²„íŠ¼ ìˆ¨ê¹€
            if (editBtn) editBtn.style.display = 'none';
            if (deleteBtn) deleteBtn.style.display = 'none';
        }

        // 4. ëŒ“ê¸€ ë Œë”ë§
        renderComments(post.comments || []);
    }

    // â­â­ ëŒ€ëŒ“ê¸€ í¼ ì œê±° í•¨ìˆ˜ (ìœ ì§€) â­â­
    function removeReplyForm(targetCommentId) {
        const form = document.querySelector(`.reply-form-container[data-parent-id="${targetCommentId}"]`);
        if (form) {
            form.remove();
        }
    }

    // â­â­ ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ëŒ€ëŒ“ê¸€ ìœ„ì¹˜ ì¡°ì •) (ìœ ì§€) â­â­
    function renderComments(comments) {
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';

        if (comments.length === 0) {
            commentsList.innerHTML = '<p style="color: #999; padding: 10px 0; text-align: center;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
            return;
        }

        // 1. DOM ìš”ì†Œë¥¼ ì €ì¥í•  ë§µ
        const commentMap = {};

        comments.forEach(comment => {
            const isMyComment = String(comment.writerId) === String(CURRENT_USER_ID); // ID ë¹„êµ
            const isReply = comment.parentCommentId !== null;

            // â­ [ìˆ˜ì •] í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ìˆ˜ì •/ì‚­ì œ ê¶Œí•œë§Œ ê°€ì§€ê³ , ë‹µê¸€ ë²„íŠ¼ì€ ëª¨ë“  ëŒ“ê¸€ì— í‘œì‹œ
            let actions = `<button onclick="handleReply(${comment.id}, '${comment.writer}', event)" class="reply">ë‹µê¸€</button>`;

            if (isMyComment) {
                actions += `
                    <button onclick="handleCommentEdit(${comment.id}, '${comment.content}')">ìˆ˜ì •</button>
                    <button onclick="handleCommentDelete(${comment.id})">ì‚­ì œ</button>
                `;
            }

            const item = document.createElement('div');
            item.className = `comment-item ${isReply ? 'reply' : ''}`;
            item.dataset.commentId = comment.id;

            item.innerHTML = `
                <div class="comment-header-row">
                    <div class="comment-meta">
                        <span class="comment-writer">${comment.writer} ${isMyComment ? '(ë‚˜)' : ''}</span>
                        <span class="comment-date">${comment.date}</span>
                    </div>
                    <div class="comment-actions">
                        ${actions}
                    </div>
                </div>
                <div class="comment-content">${comment.content}</div>
            `;

            commentMap[comment.id] = item;
        });

        // 2. DOMì— ì‚½ì… (ê³„ì¸µ êµ¬ì¡°ì— ë”°ë¼ ë¶€ëª¨ ëŒ“ê¸€ ë’¤ì— ì‚½ì…)
        comments.forEach(comment => {
            const commentElement = commentMap[comment.id];

            if (comment.parentCommentId === null) {
                // ìµœìƒìœ„ ëŒ“ê¸€ì€ commentsListì— ì§ì ‘ ì‚½ì…
                commentsList.appendChild(commentElement);
            } else {
                // ëŒ€ëŒ“ê¸€ì€ ë¶€ëª¨ ëŒ“ê¸€ì„ ì°¾ì•„ ê·¸ ë’¤ì— ì‚½ì…
                const parentElement = commentMap[comment.parentCommentId];
                if (parentElement) {
                    parentElement.insertAdjacentElement('afterend', commentElement);
                } else {
                    // ë¶€ëª¨ê°€ ì—†ìœ¼ë©´ ìµœìƒìœ„ì— ì‚½ì… (ì˜¤ë¥˜ ëŒ€ë¹„)
                    commentsList.appendChild(commentElement);
                }
            }
        });
    }

    // â­â­ ëŒ“ê¸€ ì‘ì„± ë¡œì§ (ìˆ˜ì •) â­â­
    function submitComment() {
        const commentInput = document.getElementById('comment-input');
        const content = commentInput.value.trim();

        if (content.length === 0) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const newComment = {
            id: Date.now(),
            writer: CURRENT_USER_WRITER_NAME, // â­ ë¡œê·¸ì¸ ì‚¬ìš©ì ë‹‰ë„¤ì„ ì‚¬ìš©
            writerId: CURRENT_USER_ID, // ID ì €ì¥
            date: new Date().toISOString().slice(0, 10),
            content: content,
            parentCommentId: null // ìµœìƒìœ„ ëŒ“ê¸€ë¡œ ë“±ë¡
        };

        if (window.POST_DATA) {
            if (!window.POST_DATA.comments) window.POST_DATA.comments = [];
            window.POST_DATA.comments.push(newComment);
            renderComments(window.POST_DATA.comments);
            commentInput.value = '';
            document.getElementById('comment-count').textContent = window.POST_DATA.comments.length;
            document.getElementById('detail-comments').textContent = `ëŒ“ê¸€: ${window.POST_DATA.comments.length}`;
        }

        console.log("ëŒ“ê¸€ ì œì¶œ", newComment);
    }


    // â­â­ ëŒ“ê¸€ CRUD Mock í•¨ìˆ˜ êµ¬í˜„ (ìˆ˜ì •) â­â­
    function handleCommentEdit(commentId, currentContent) {
        // â­â­â­ [ìˆ˜ì •] í”„ë¡¬í”„íŠ¸ ë©”ì‹œì§€ì—ì„œ ID ì œê±° â­â­â­
        const newContent = prompt(`ëŒ“ê¸€ ìˆ˜ì •:`, currentContent);

        if (newContent && newContent.trim().length > 0) {
            const commentToUpdate = window.POST_DATA.comments.find(c => c.id === commentId);
            if (commentToUpdate) {
                commentToUpdate.content = newContent.trim();
                commentToUpdate.date = new Date().toISOString().slice(0, 10) + ' (ìˆ˜ì •ë¨)';
                renderComments(window.POST_DATA.comments);
            }
            alert("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else if (newContent !== null) {
            alert("ìˆ˜ì •í•  ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
    }

    function handleCommentDelete(commentId) {
        if (confirm(`ëŒ“ê¸€ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const initialLength = window.POST_DATA.comments.length;
            window.POST_DATA.comments = window.POST_DATA.comments.filter(c => c.id !== commentId);

            if (window.POST_DATA.comments.length < initialLength) {
                renderComments(window.POST_DATA.comments);
                document.getElementById('comment-count').textContent = window.POST_DATA.comments.length;
                document.getElementById('detail-comments').textContent = `ëŒ“ê¸€: ${window.POST_DATA.comments.length}`;
                alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }
    }

    // â­â­ ëŒ€ëŒ“ê¸€ ê¸°ëŠ¥ UI: í¼ ë™ì  ìƒì„± ë° ì‚½ì… (ìœ ì§€) â­â­
    function handleReply(commentId, writerName, event) {
        const parentComment = event.target.closest('.comment-item');

        // 1. ë‹¤ë¥¸ ì—´ë ¤ìˆëŠ” í¼ ë‹«ê¸°
        document.querySelectorAll('.reply-form-container').forEach(form => form.remove());

        // 2. ìƒˆë¡œìš´ í¼ ìƒì„±
        const replyFormHTML = `
            <div class="reply-form-container" data-parent-id="${commentId}">
                <h4 style="font-size: 14px; margin-bottom: 8px;">${writerName}ë‹˜ì—ê²Œ ë‹µê¸€ ì‘ì„±:</h4>
                <textarea id="reply-input-${commentId}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="2"></textarea>

                <button class="btn-reply-cancel" onclick="removeReplyForm(${commentId})" style="float: right;">ì·¨ì†Œ</button>
                <button onclick="submitReply(${commentId}, '${writerName}')" style="float: right; margin-right: 10px; background-color: #6c5ce7; color: white;">ë“±ë¡</button>
                <div style="clear: both;"></div>
            </div>
        `;

        // ëŒ“ê¸€ í•­ëª© ë°”ë¡œ ì•„ë˜ì— í¼ ì‚½ì…
        parentComment.insertAdjacentHTML('afterend', replyFormHTML);

        // 3. ìƒˆë¡œ ìƒì„±ëœ textareaì— í¬ì»¤ìŠ¤
        const replyTextarea = document.getElementById(`reply-input-${commentId}`);
        if (replyTextarea) {
            replyTextarea.focus();
        }
    }

    // â­â­ ëŒ€ëŒ“ê¸€ í¼ ì œê±° í•¨ìˆ˜ (ìœ ì§€) â­â­
    function removeReplyForm(targetCommentId) {
        const form = document.querySelector(`.reply-form-container[data-parent-id="${targetCommentId}"]`);
        if (form) {
            form.remove();
        }
    }

    // â­â­ ëŒ€ëŒ“ê¸€ ì œì¶œ (Mock) (ìˆ˜ì •) â­â­
    function submitReply(parentCommentId, writerName) {
        const replyInput = document.getElementById(`reply-input-${parentCommentId}`);
        const content = replyInput.value.trim();

        if (content.length === 0) {
            alert("ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const newComment = {
            id: Date.now(),
            writer: CURRENT_USER_WRITER_NAME, // â­ ë¡œê·¸ì¸ ì‚¬ìš©ì ë‹‰ë„¤ì„ ì‚¬ìš©
            writerId: CURRENT_USER_ID,
            date: new Date().toISOString().slice(0, 10),
            content: content,
            parentCommentId: parentCommentId
        };

        if (window.POST_DATA) {
            if (!window.POST_DATA.comments) window.POST_DATA.comments = [];
            window.POST_DATA.comments.push(newComment);

            // í¼ ì œê±°
            removeReplyForm(parentCommentId);

            // ğŸ‘‰ ëŒ“ê¸€ë§Œ ìƒˆë¡œ ë Œë”ë§
            renderComments(window.POST_DATA.comments);

            alert(`[ë‹µê¸€ ë“±ë¡ ì™„ë£Œ] ${writerName}ë‹˜ì—ê²Œ ë‹µê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
    }


    function handleDeletePost() {
        if (confirm(`ì •ë§ë¡œ ê²Œì‹œê¸€ [${window.POST_DATA.title}]ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ ì‚­ì œ ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•¨ (community.htmlê³¼ ì—°ë™)
            let posts = JSON.parse(localStorage.getItem('community_posts')) || [];
            posts = posts.filter(p => String(p.id) !== String(window.POST_DATA.postId));
            localStorage.setItem('community_posts', JSON.stringify(posts));

            alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
            location.href = '/community';
        }
    }

    function handleEditPost() {
        alert("ê²Œì‹œê¸€ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤. (êµ¬í˜„ í•„ìš”)");
        location.href = `/community/write?edit=${window.POST_DATA.postId}`;
    }
</script>