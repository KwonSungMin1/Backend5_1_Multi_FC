<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - í”„ë¡œí•„ ìˆ˜ì •</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit" class="active"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>
</header>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section">
            <div class="login-container">

                <!-- ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸ ì˜ì—­ -->
                <div id="password-confirmation-wrapper">
                    <h1 class="title-login">ë³´ì•ˆ í™•ì¸</h1>
                    <p style="margin-bottom: 20px; font-size: 15px; color: #555;">íšŒì› ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•˜ê¸° ìœ„í•´<br>ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    <p id="confirm-error-message" class="error-message" style="display:none;"></p>
                    <form id="password-confirm-form">
                        <div class="input-group">
                            <label for="current-password-confirm">ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="current-password-confirm" required>
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 20px;">í™•ì¸</button>
                    </form>
                </div>

                <!-- ì‹¤ì œ ë‚´ ì •ë³´ ìˆ˜ì • ì˜ì—­ -->
                <div id="profile-edit-wrapper" style="display:none;">
                    <h1 class="title-login">ë‚´ ì •ë³´ ìˆ˜ì •</h1>

                    <p id="profile-success-message" class="info-message" style="display:none;"></p>
                    <p id="profile-error-message" class="error-message" style="display:none;"></p>
                    <p id="nickname-message" class="info-message" style="display:none;"></p>

                    <form id="profile-update-form" enctype="multipart/form-data">

                        <!-- ğŸ”¹ ì´ë©”ì¼ ìˆ˜ì • ì¶”ê°€ -->
                        <div class="input-group">
                            <label for="email">ì´ë©”ì¼</label>
                            <input type="email"
                                   id="email"
                                   name="email"
                                   placeholder="example@multi.com"
                                   required>
                        </div>

                        <!-- ë‹‰ë„¤ì„ + ì¤‘ë³µ í™•ì¸ ë²„íŠ¼ -->
                        <div class="input-group with-button">
                            <div class="input-wrapper">
                                <label for="nickname">ë‹‰ë„¤ì„</label>
                                <input type="text" id="nickname" name="nickname" placeholder="ìƒˆ ë‹‰ë„¤ì„" required>
                            </div>
                            <button type="button" id="check-nickname-btn" class="check-duplicate-btn">ì¤‘ë³µ í™•ì¸</button>
                        </div>

                        <!-- í¬ì§€ì…˜ ì„¤ì • -->
                        <div class="input-group">
                            <label for="position">í¬ì§€ì…˜ ì„¤ì •</label>
                            <select id="position" name="position" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                                <option value="ALL">ì „ì²´ (ALL)</option>
                                <option value="FIXO">í”½ì†Œ (FIXO)</option>
                                <option value="ALA">ì•„ë¼ (ALA)</option>
                                <option value="PIVO">í”¼ë³´ (PIVO)</option>
                                <option value="GOLEIRO">ê³¨ë ˆì´ë¡œ (GOLEIRO)</option>
                            </select>
                        </div>

                        <!-- ğŸ”¹ ì‹¤ë ¥ ë ˆë²¨ ìˆ˜ì • ì¶”ê°€ -->
                        <div class="input-group">
                            <label for="skill-level">ë‚˜ì˜ ì‹¤ë ¥ ë ˆë²¨</label>
                            <select id="skill-level" name="skillLevel" required
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                                <option value="">ì‹¤ë ¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="beginner">ì´ˆê¸‰</option>
                                <option value="intermediate">ì¤‘ê¸‰</option>
                                <option value="advanced">ê³ ê¸‰</option>
                            </select>
                        </div>

                        <!-- í™œë™ ì¥ì†Œ -->
                        <div class="input-group">
                            <label for="location">í™œë™ ì¥ì†Œ ì„¤ì •</label>
                            <input type="text" id="location" name="location" placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬" required>
                        </div>

                        <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                        <div class="input-group">
                            <label>í”„ë¡œí•„ ì‚¬ì§„ ìˆ˜ì •</label>
                            <img id="profile-preview" th:src="@{/images/default-profile.png}" alt="í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #ddd;">
                            <input type="file" id="profile-pic" name="profilePic" accept="image/*">
                        </div>

                        <button type="submit" id="profile-submit-btn" class="login-button" style="margin-top: 15px;" disabled>
                            ì •ë³´ ì €ì¥
                        </button>
                    </form>

                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 40px; border-top: 1px solid #ddd; padding-top: 30px;">ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •</h3>
                    <p id="password-success-message" class="info-message" style="display:none;"></p>
                    <p id="password-error-message" class="error-message" style="display:none;"></p>

                    <form id="password-change-form">
                        <div class="input-group">
                            <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="current-password" name="currentPassword" required>
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="new-password" name="newPassword" placeholder="8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì ì¡°í•©" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="confirm-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="confirm-password" name="confirmPassword" required>
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 15px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë° ë¡œê·¸ì•„ì›ƒ ë¡œì§ ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');

    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        if (!mainMenu.contains(event.target) && !menuToggle.contains(event.target) &&
            !profileMenu.contains(event.target) && !profileMenuToggle.contains(event.target)) {
            mainMenu.classList.remove('show');
            profileMenu.classList.remove('show');
        }
    });

    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }

    // --- (â˜…ê³µí†µâ˜…) ì•Œë¦¼ ë°°ì§€ ë¡œë“œ í•¨ìˆ˜ ---
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;

    function updateGlobalBadge() {
        if (hasReviewNotif || hasScheduleNotif) {
            if (badge) badge.style.display = 'block';
        } else {
            if (badge) badge.style.display = 'none';
        }
    }
    async function checkPendingReviews() {
        if (localStorage.getItem('hasReadReviews') === 'true') {
            hasReviewNotif = false;
            return;
        }
        try {
            await new Promise(r => setTimeout(r, 200));
            const mockReviews = { "count": 1 };
            if (mockReviews.count > 0) {
                hasReviewNotif = true;
            }
        } catch (error) { console.error("í›„ê¸° ì•Œë¦¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:", error); }
    }
    async function checkUpcomingSchedules() {
        if (localStorage.getItem('hasReadSchedules') === 'true') {
            hasScheduleNotif = false;
            return;
        }
        try {
            await new Promise(r => setTimeout(r, 500));
            const mockSchedules = [ { id: 1, date: "2025-11-01" } ];
            if (mockSchedules.length > 0) {
                hasScheduleNotif = true;
            }
        } catch (error) { console.error("ì¼ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error); }
    }

    // --- (â˜…í˜ì´ì§€ë³„â˜…) ë¡œì§ ì‹¤í–‰ ---
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');

        if (accessToken) {
            // [íšŒì›ì¼ ë•Œ]
            if (profileMenuToggle) profileMenuToggle.style.display = 'block';
            if (navLoginLink) navLoginLink.parentElement.style.display = 'none';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'list-item';

            // (â˜…) ê¸€ë¡œë²Œ ì•Œë¦¼ ë°°ì§€ ì²´í¬
            await checkPendingReviews();
            await checkUpcomingSchedules();
            updateGlobalBadge();

            // (â˜…) profile-edit.html ê³ ìœ  ë¡œì§ì€
            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸(confirmForm) ì„±ê³µ ì‹œ fetchMyEditInfo() í˜¸ì¶œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

        } else {
            // [ë¹„íšŒì›ì¼ ë•Œ]
            if (profileMenuToggle) profileMenuToggle.style.display = 'none';
            if (navLoginLink) navLoginLink.parentElement.style.display = 'list-item';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'none';

            // (í˜ì´ì§€ ì ‘ê·¼ ì œì–´)
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
        }
    });

    // --- (â˜…í˜ì´ì§€ë³„â˜…) profile-edit.html ê³ ìœ  í•¨ìˆ˜ë“¤ ---

    // (ë¹„ë°€ë²ˆí˜¸ í† ê¸€ - ë™ì¼)
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const passwordInput = this.parentElement.querySelector('input[type="password"], input[type="text"]');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    // (í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° - ë™ì¼)
    const profilePicInput = document.getElementById('profile-pic');
    const profilePreview = document.getElementById('profile-preview');
    if(profilePicInput) {
        profilePicInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePreview.src = e.target.result;
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    // (ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í¼ - ë™ì¼)
    const confirmForm = document.getElementById('password-confirm-form');
    const confirmButton = confirmForm.querySelector('button[type="submit"]');
    const confirmPasswordInput = document.getElementById('current-password-confirm');
    const confirmErrorMsg = document.getElementById('confirm-error-message');
    const confirmWrapper = document.getElementById('password-confirmation-wrapper');
    const editWrapper = document.getElementById('profile-edit-wrapper');
    let attemptCount = 0;
    const MAX_ATTEMPTS = 5;

    confirmForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        confirmErrorMsg.style.display = 'none';
        if (attemptCount >= MAX_ATTEMPTS) {
            confirmErrorMsg.textContent = 'âŒ 5íšŒ ì´ìƒ ì‹¤íŒ¨í•˜ì—¬ í™•ì¸ì´ ì ê²¼ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            confirmErrorMsg.style.display = 'block';
            return;
        }
        const password = confirmPasswordInput.value;
        if (!password) {
            confirmErrorMsg.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            confirmErrorMsg.style.display = 'block';
            return;
        }
        confirmButton.disabled = true;
        confirmButton.textContent = 'í™•ì¸ ì¤‘...';

        try {
            const response = await fetch('/profile/confirm-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: JSON.stringify({ currentPassword: password })
            });

            if (response.ok) {
                confirmWrapper.style.display = 'none';
                editWrapper.style.display = 'block';
                fetchMyEditInfo(); // (â˜…) ì„±ê³µ ì‹œ ì‹¤ì œ ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
                attemptCount++;
                const data = await response.json();
                if (attemptCount >= MAX_ATTEMPTS) {
                    confirmErrorMsg.textContent = 'âŒ 5íšŒ ì‹¤íŒ¨í•˜ì—¬ í™•ì¸ì´ ì ê²¼ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    confirmButton.disabled = true;
                    confirmPasswordInput.disabled = true;
                } else {
                    confirmErrorMsg.textContent = `âŒ ${data.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'} (${MAX_ATTEMPTS - attemptCount}íšŒ ë‚¨ìŒ)`;
                    confirmPasswordInput.value = '';
                    confirmPasswordInput.focus();
                }
                confirmErrorMsg.style.display = 'block';
            }
        } catch (error) {
            attemptCount++;
            confirmErrorMsg.textContent = `âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${MAX_ATTEMPTS - attemptCount}íšŒ ë‚¨ìŒ)`;
            confirmErrorMsg.style.display = 'block';
        } finally {
            if (attemptCount < MAX_ATTEMPTS) {
                confirmButton.disabled = false;
                confirmButton.textContent = 'í™•ì¸';
            }
        }
    });

    // --- ë‹‰ë„¤ì„ / í”„ë¡œí•„ ìˆ˜ì • ë¡œì§ ---
    const nicknameInput = document.getElementById('nickname');
    const checkNicknameBtn = document.getElementById('check-nickname-btn');
    const nicknameMsg = document.getElementById('nickname-message');
    const profileSubmitBtn = document.getElementById('profile-submit-btn');
    const profileErrorMsg = document.getElementById('profile-error-message');
    const profileForm = document.getElementById('profile-update-form');
    const profileSuccessMsg = document.getElementById('profile-success-message');

    // ğŸ”¹ ìƒˆë¡œ ì¶”ê°€ëœ ìš”ì†Œ: ì´ë©”ì¼, ì‹¤ë ¥ ë ˆë²¨
    const emailInput = document.getElementById('email');
    const skillLevelSelect = document.getElementById('skill-level');

    let isNicknameChecked = true;
    let originalNickname = "";

    // ğŸ”¹ ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ë”ë¯¸ â†’ ë‚˜ì¤‘ì— ì‹¤ì œ APIë¡œ êµì²´)
    async function fetchMyEditInfo() {
        await new Promise(r => setTimeout(r, 100));
        const myInfo = {
            email: "real.user@example.com",
            nickname: "ë¦¬ì–¼ìœ ì €",
            position: "FIXO",      // í’‹ì‚´ í¬ì§€ì…˜
            location: "ì„œìš¸ì‹œ ì„œì´ˆêµ¬",
            skillLevel: "intermediate", // beginner / intermediate / advanced
            profilePicUrl: null
        };

        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        emailInput.value = myInfo.email;
        nicknameInput.value = myInfo.nickname;
        document.getElementById('position').value = myInfo.position;
        document.getElementById('location').value = myInfo.location;

        if (myInfo.skillLevel) {
            skillLevelSelect.value = myInfo.skillLevel;
        } else {
            skillLevelSelect.value = "";
        }

        if (myInfo.profilePicUrl) {
            profilePreview.src = myInfo.profilePicUrl;
        }

        originalNickname = myInfo.nickname;
        isNicknameChecked = true;

        profileSubmitBtn.disabled = false;
        profileSubmitBtn.textContent = 'ì •ë³´ ì €ì¥';
    }

    // ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ìƒíƒœ ë³€ê²½
    nicknameInput.addEventListener('input', () => {
        nicknameMsg.style.display = 'none';
        if (nicknameInput.value === originalNickname) {
            isNicknameChecked = true;
            checkNicknameBtn.disabled = true;
            checkNicknameBtn.classList.remove('success');
            profileSubmitBtn.disabled = false;
            profileSubmitBtn.textContent = 'ì •ë³´ ì €ì¥';
        } else {
            isNicknameChecked = false;
            checkNicknameBtn.disabled = false;
            checkNicknameBtn.classList.remove('success');
            profileSubmitBtn.disabled = true;
            profileSubmitBtn.textContent = 'ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ í•„ìš”';
        }
    });

    // ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ ë²„íŠ¼ í´ë¦­
    checkNicknameBtn.addEventListener('click', async () => {
        profileErrorMsg.style.display = 'none';
        const nickname = nicknameInput.value.trim();
        if (!nickname) {
            nicknameMsg.textContent = 'âŒ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            nicknameMsg.className = 'error-message';
            nicknameMsg.style.display = 'block';
            return;
        }
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            const isDuplicate = (nickname === 'futsal'); // ë”ë¯¸
            if (isDuplicate) {
                nicknameMsg.textContent = 'âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                nicknameMsg.className = 'error-message';
                isNicknameChecked = false;
            } else {
                nicknameMsg.textContent = 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                nicknameMsg.className = 'info-message';
                isNicknameChecked = true;
                checkNicknameBtn.disabled = true;
                checkNicknameBtn.classList.add('success');
                profileSubmitBtn.disabled = false;
                profileSubmitBtn.textContent = 'ì •ë³´ ì €ì¥';
            }
            nicknameMsg.style.display = 'block';
        } catch (error) {
            profileErrorMsg.textContent = 'âŒ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            profileErrorMsg.style.display = 'block';
            isNicknameChecked = false;
        }
    });

    // --- í”„ë¡œí•„ ì •ë³´ ìˆ˜ì • í¼ ì œì¶œ ---
    profileForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        profileSuccessMsg.style.display = 'none';
        profileErrorMsg.style.display = 'none';

        if (!isNicknameChecked) {
            profileErrorMsg.textContent = 'âŒ ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.';
            profileErrorMsg.style.display = 'block';
            return;
        }

        const formData = new FormData(profileForm);
        try {
            const response = await fetch('/profile/update', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                }
            });
            const data = await response.json();
            if (response.ok) {
                profileSuccessMsg.textContent = 'âœ… ' + data.message;
                profileSuccessMsg.style.display = 'block';
                originalNickname = nicknameInput.value;
                checkNicknameBtn.disabled = true;
            } else {
                profileErrorMsg.textContent = 'âŒ ' + data.message;
                profileErrorMsg.style.display = 'block';
            }
        } catch (error) {
            profileErrorMsg.textContent = 'âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            profileErrorMsg.style.display = 'block';
        }
    });

    // --- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ ë¡œì§ ---
    const passwordForm = document.getElementById('password-change-form');
    const passwordSuccessMsg = document.getElementById('password-success-message');
    const passwordErrorMsg = document.getElementById('password-error-message');

    passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        passwordSuccessMsg.style.display = 'none';
        passwordErrorMsg.style.display = 'none';

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const currentPassword = document.getElementById('current-password').value;

        if (newPassword !== confirmPassword) {
            passwordErrorMsg.textContent = 'âŒ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            passwordErrorMsg.style.display = 'block';
            return;
        }
        try {
            const response = await fetch('/profile/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: JSON.stringify({
                    currentPassword: currentPassword,
                    newPassword: newPassword
                }),
            });
            const data = await response.json();
            if (response.ok) {
                passwordSuccessMsg.textContent = 'âœ… ' + data.message;
                passwordSuccessMsg.style.display = 'block';
                passwordForm.reset();
            } else {
                passwordErrorMsg.textContent = 'âŒ ' + data.message;
                passwordErrorMsg.style.display = 'block';
            }
        } catch (error) {
            passwordErrorMsg.textContent = 'âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            passwordErrorMsg.style.display = 'block';
        }
    });
</script>
</body>
</html>
