<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - 게시글 작성/수정</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .community-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .board-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .write-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }
        .write-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        .write-controls button {
            padding: 8px 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-save {
            background-color: #6c5ce7;
            color: white;
            border: none;
        }
        .btn-cancel {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
            margin-right: 10px;
        }

        .write-form input[type="text"],
        .write-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            background: #f7f7f7;
            font-family: inherit;
        }

        /* 카테고리 SELECT 박스 너비 제한 (이전 요청사항 반영) */
        .write-form #category {
            width: auto;
            min-width: 180px;
            max-width: 250px;
        }


        /* Quill 툴바와 에디터 영역이 하나로 보이도록 조정 */
        #editor-container {
            border: 1px solid #ddd;
            border-top: none; /* 툴바와 연결된 것처럼 보이기 위해 상단 테두리 제거 */
            border-radius: 0 0 8px 8px;
            background: #f7f7f7;
            height: 300px;
            margin-bottom: 25px; /* 버튼과의 간격 조정 */
        }

        /* Quill 툴바 스타일 오버라이드 (UI 일관성 유지) */
        .ql-toolbar.ql-snow {
            background: #ecf0f1;
            border: 1px solid #ddd;
            border-bottom: none;
            /* 툴바 상단 마진 및 둥근 테두리 조정 */
            border-radius: 8px 8px 0 0; /* 상단만 둥글게 유지 */
            padding: 8px 10px;
        }
        .ql-container.ql-snow {
            border: none; /* 바깥 컨테이너 테두리 제거 */
        }

        /* Quill undo/redo 버튼 스타일 */
        .ql-toolbar .ql-undo::before,
        .ql-toolbar .ql-redo::before {
            content: none !important;
        }
        .ql-toolbar .ql-undo,
        .ql-toolbar .ql-redo {
            position: relative;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
        }
        .ql-toolbar .ql-undo i,
        .ql-toolbar .ql-redo i {
            font-size: 16px;
            line-height: 1;
        }

    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">사용자</span>님</strong>
                <p>환영합니다!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> 알림 목록</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> 프로필 수정</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
            <li><a href="/community" class="active"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> 실시간채팅</a></li>
            <li><a href="/schedule"><i class="fas fa-calendar-alt"></i> 일정</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> 로그인</a></li>
            <li><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="board-container">

        <!-- ✅ 작성/수정 폼 -->
        <p id="post-success-message" class="info-message" style="display:none;"></p>
        <p id="post-error-message" class="error-message" style="display:none;"></p>

        <form id="write-form">
            <div class="write-header">
                <h1>새 게시글 작성</h1>
                <div class="write-controls">
                    <button type="button" class="btn-cancel" onclick="history.back()">취소</button>
                    <button type="submit" class="btn-save">등록</button>
                </div>
            </div>

            <div class="write-form">
                <div class="input-group">
                    <label for="category">카테고리 선택</label>
                    <select id="category" name="category" required>
                        <option value="notice">공지</option>
                        <option value="free">자유</option>
                        <option value="team">팀원 모집</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="title">제목</label>
                    <input type="text" id="title" name="title" placeholder="제목을 입력하세요" required>
                </div>

                <div id="editor-container"></div>
            </div>

            <input type="hidden" id="post-content-html" name="contentHtml">
        </form>
    </div>
</main>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // --- (★공통★) 메뉴 토글 및 로그아웃 로직 (유지) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }

    document.addEventListener('click', (event) => {
        const isClickInsideHeader = document.querySelector('header').contains(event.target);
        if (!isClickInsideHeader) {
            mainMenu.classList.remove('show');
            if (profileMenu) profileMenu.classList.remove('show');
        }
    });

    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }

    // --- (★공통★) URL 기반 메뉴 활성화 함수 (유지) ---
    function setActiveMenuItem() {
        const path = window.location.pathname;
        const navLinks = document.querySelectorAll('#main-menu a');

        navLinks.forEach(link => {
            link.classList.remove('active');
        });

        navLinks.forEach(link => {
            const href = link.getAttribute('href');

            if (path === '/' && href === '/') {
                link.classList.add('active');
            } else if (path.startsWith('/community') && href === '/community') {
                link.classList.add('active');
            } else if (href !== '/' && path.startsWith(href)) {
                link.classList.add('active');
            }
        });
    }

    // --- (★추가★) 수정 모드 더미 데이터 (유지) ---
    const MOCK_DETAIL_POSTS = {
        10: {
            category: 'notice',
            title: '[필독] 공지사항 및 매너 점수 안내',
            contentHtml: '<p>안녕하세요. FUTSAL MATCH입니다. 원활하고 공정한 경기 매칭을 위해 매너 점수(Manner Score) 시스템을 다음과 같이 개편합니다.</p><p><b>변경 규정을 숙지하여 주시기 바랍니다.</b></p>',
        },
    };

    /**
     * 게시글 ID를 받아 수정 모드로 폼을 로드합니다. (유지)
     */
    /**
     * 게시글 ID를 받아 수정 모드로 폼을 로드합니다. (로컬스토리지 연동)
     */
    function loadPostForEdit(postId) {
        let posts = [];
        try {
            const storedData = localStorage.getItem('community_posts');
            if (storedData) posts = JSON.parse(storedData);
        } catch (e) {
            console.error("로컬스토리지 파싱 오류:", e);
            posts = [];
        }

        const post = posts.find(p => String(p.id) === String(postId));

        const headerTitle = document.querySelector('.write-header h1');
        const submitBtn = document.querySelector('.btn-save');

        if (!post) {
            alert("❌ 수정할 게시물 정보를 찾을 수 없습니다.");
            window.location.href = '/community';
            return;
        }


        // ✅ UI 변경
        headerTitle.textContent = `게시글 수정 (ID: ${postId})`;
        submitBtn.textContent = '수정';

        // ✅ 데이터 채우기
        document.getElementById('category').value = post.category;
        document.getElementById('title').value = post.title;


        // ✅ Quill 에디터 내용 반영
        const quillEditor = Quill.find(document.querySelector('#editor-container'));
        if (quillEditor && post.content) {
            quillEditor.root.innerHTML = post.content;
        }

        // ✅ 수정 대상 ID를 form dataset에 저장
        writeForm.dataset.postId = postId;
    }

    // ------------------------------------


    let quill; // Quill 에디터를 전역/로컬 스코프에서 사용 가능하도록 선언

    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const currentPath = window.location.pathname;

        if (!accessToken) {
            alert("로그인이 필요한 페이지입니다.");
            localStorage.setItem('redirectAfterLogin', currentPath);
            window.location.href = '/login';
            return;
        }

        // ⭐⭐⭐ 1. Quill Editor 초기화 - Undo/Redo 기능 연결 ⭐⭐⭐
        const toolbarOptions = [
            [{'header': [1, 2, false]}],
            ['bold', 'italic', 'underline', 'strike'],
            [{'list': 'ordered'}, {'list': 'bullet'}],
            ['link', 'image'],
            ['undo', 'redo'],
            ['clean']
        ];

        quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: '내용을 입력하세요.',
            modules: {
                toolbar: {
                    container: toolbarOptions,
                },
                history: {
                    delay: 100,
                    maxStack: 50,
                    userOnly: true
                }
            }
        });

        // 툴바 버튼에 Font Awesome 아이콘 바인딩 (Quill 기본 아이콘 오버라이드)
        const toolbar = quill.getModule('toolbar');
        if (toolbar) {
            const undoButton = document.querySelector('.ql-undo');
            const redoButton = document.querySelector('.ql-redo');

            if (undoButton) undoButton.innerHTML = '<i class="fas fa-undo"></i>';
            if (redoButton) redoButton.innerHTML = '<i class="fas fa-redo"></i>';
        }
        // -----------------------------


        // 2. 메뉴 활성화 함수 실행
        setActiveMenuItem();

        // ⭐⭐ 3. 수정 모드 체크 및 데이터 로드 ⭐⭐
        const urlParams = new URLSearchParams(window.location.search);
        const editPostId = urlParams.get('id') || urlParams.get('edit');

        if (editPostId) {
            loadPostForEdit(editPostId);
        } else {
            // 작성 모드인 경우 기본 UI 유지
            document.querySelector('.write-header h1').textContent = '새 게시글 작성';
            document.querySelector('.btn-save').textContent = '등록';
        }
    });


    // --- (★페이지별★) 게시글 작성/수정 로직 ---
    const writeForm = document.getElementById('write-form');
    const postContentHtmlInput = document.getElementById('post-content-html'); // 숨겨진 필드
    const successMsg = document.getElementById('post-success-message');
    const errorMsg = document.getElementById('post-error-message');

    // ⭐⭐⭐ [최종 수정] 폼 제출 시 로컬 스토리지에 저장하고 이동하도록 로직 변경 ⭐⭐⭐
    writeForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        successMsg.style.display = 'none';
        errorMsg.style.display = 'none';

        const category = document.getElementById('category').value;
        const title = document.getElementById('title').value.trim();
        const quillEditor = Quill.find(document.querySelector('#editor-container'));
        const contentHtml = quillEditor.root.innerHTML;
        const contentText = quillEditor.getText().trim();

        postContentHtmlInput.value = contentHtml; // HTML 내용을 숨겨진 필드에 저장

        // ⭐ ID 생성 및 액션 정의: ID는 문자열로 저장하여 로컬스토리지에서 정렬 문제를 피합니다.
        const postId = writeForm.dataset.postId || String(Date.now());
        const actionName = writeForm.dataset.postId ? '수정' : '등록';

        // ★ 유효성 검사
        if (title === '' || contentText.length <= 1) {
            errorMsg.textContent = '❌ 제목, 카테고리, 내용을 모두 입력해주세요.';
            errorMsg.style.display = 'block';
            return;
        }

        // ✅ 한국 시간 기준 yyyy-mm-dd hh:mm 문자열 생성
        const today = new Date();
        const koreaOffset = today.getTime() + (today.getTimezoneOffset() * 60000) + (9 * 60 * 60 * 1000);
        const koreaDate = new Date(koreaOffset);
        const formattedDate = koreaDate.toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
        });

        // ✅ 게시글 객체 생성
        let categoryDisplayValue = '';
        switch (category) {
            case 'notice':
                categoryDisplayValue = '공지';
                break;
            case 'free':
                categoryDisplayValue = '자유';
                break;
            case 'team':
                categoryDisplayValue = '팀모집';
                break;
            default:
                categoryDisplayValue = '기타';
        }

        const newPost = {
            id: String(postId),
            category: category,
            categoryDisplay: categoryDisplayValue,
            title: title,
            content: contentHtml,
            writer: '현재 사용자',
            date: formattedDate, // ✅ 한국 시간 기준
            commentCount: 0,
            viewCount: 0,
            writerId: 999 // 더미 writerId 추가 (권한 체크 대비)
        };

        // ✅ 로컬 스토리지에 글 목록 업데이트
        let posts = JSON.parse(localStorage.getItem('community_posts')) || [];

        if (writeForm.dataset.postId) {
            // 수정 모드
            const index = posts.findIndex(p => String(p.id) === postId);
            if (index !== -1) {
                posts[index] = {...posts[index], ...newPost};
            }
        } else {
            // 등록 모드
            posts.unshift(newPost);
        }

        localStorage.setItem('community_posts', JSON.stringify(posts));

        // ✅ 성공 메시지 및 리다이렉션
        successMsg.textContent = `✅ 게시글이 성공적으로 ${actionName}되었습니다. 커뮤니티로 이동합니다.`;
        successMsg.style.display = 'block';

        setTimeout(() => {
            const uniqueStamp = Date.now();
            window.location.href = `/community?refresh=${uniqueStamp}`;
        }, 1500);
    });

</script>
</body>
</html>