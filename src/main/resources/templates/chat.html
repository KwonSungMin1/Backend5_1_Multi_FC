<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .chat-main {
            padding-top: 70px;
            display: flex;
            min-height: 100vh;
            background-color: #f7f7f7;
            position: relative;
            overflow-x: hidden;
            transition: all 0.3s ease-in-out;
        }
        .chat-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .chat-content-area {
            flex-grow: 1;
            background: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease-in-out;
            min-width: 0;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        .chat-type-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0 0;
            margin-bottom: 0;
            border-bottom: 1px solid #eee;
        }
        .chat-type-tabs button {
            flex-grow: 1;
            padding: 10px 5px;
            margin: 0;
            background: none !important;
            border: none !important;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            outline: none;
        }
        .chat-type-tabs button.active {
            color: #6c5ce7;
            border-bottom-color: #6c5ce7;
        }
        .chat-type-tabs button:hover:not(.active) {
            color: #2c3e50;
            background-color: transparent;
        }
        .room-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px 15px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .room-item:hover, .room-item.active {
            background-color: #f0f0f0;
        }
        .room-info {
            flex-grow: 1;
            min-width: 0;
            padding-right: 10px;
        }
        .room-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .last-message {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .delete-room-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 15px;
            cursor: pointer;
            flex-shrink: 0;
            opacity: 0.7;
            padding: 5px;
        }
        .delete-room-btn:hover {
            opacity: 1;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #eaf6ff;
        }
        .chat-input-area {
            border-top: 1px solid #ddd;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            background: white;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 15px;
        }
        .chat-input-area button {
            background-color: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .chat-input-area button:hover {
            background-color: #8e44ad;
        }
        .message-bubble {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .message-bubble.mine {
            justify-content: flex-end;
        }
        .message-bubble.mine .message-content {
            background-color: #ffe500;
            color: #191919;
            border-radius: 15px 15px 0 15px;
        }
        .message-bubble.other {
            justify-content: flex-start;
        }
        .message-bubble.other .message-content {
            background-color: white;
            color: #333;
            border-radius: 15px 15px 15px 0;
            border: 1px solid #ddd;
        }
        .message-text {
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 15px;
        }
        .message-meta {
            font-size: 11px;
            color: #888;
            align-self: flex-end;
            margin: 0 5px;
        }
        #chat-welcome-message {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #999;
            height: 100%;
            text-align: center;
        }
        #current-chat-room {
            display: none;
            flex-direction: column;
            position: relative;
            height: 100%;
            overflow: hidden;
        }
        #connection-status {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            background-color: #f0f0f0;
            color: #e74c3c;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            z-index: 990;
            display: none;
        }
        #participant-sidebar {
            position: fixed;
            top: 70px;
            right: 0;
            width: 280px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        #participant-sidebar.open {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .participant-list-container {
            flex-grow: 1;
            padding: 10px 0;
        }
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .participant-item:hover {
            background-color: #fcfcfc;
        }
        .participant-icon-wrapper {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .participant-icon-wrapper i {
            font-size: 16px;
            color: #6c5ce7;
            margin: 0;
        }
        .participant-details {
            display: flex;
            flex-direction: column;
            line-height: 1.3;
        }
        .participant-name {
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }
        .participant-role-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 5px;
            color: white;
            white-space: nowrap;
        }
        .role-admin { background-color: #6c5ce7; }
        .role-host { background-color: #e74c3c; }
        .role-me { background-color: #3498db; }
        @media (max-width: 900px) {
            .chat-main.sidebar-open {
                width: 100%;
                margin-right: 0;
            }
            #participant-sidebar {
                width: 100%;
                height: calc(100vh - 70px);
            }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
        .modal-content h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }
        .modal-content p {
            font-size: 15px;
            color: #555;
            margin-bottom: 10px;
        }
        .modal-content strong {
            color: #6c5ce7;
            margin-left: 5px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }
        .btn-create {
            background: #6c5ce7;
            color: white;
            border: none;
        }
        #new-chat-modal .modal-content input,
        #new-chat-modal .modal-content select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 15px;
        }
        .invite-friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .invite-friend-item:hover {
            background-color: #fafafa;
        }
        .invite-friend-item.selected {
            background-color: #e6e6ff;
        }
        .invite-friend-item span {
            font-size: 15px;
            color: #333;
        }
        .friend-status {
            font-size: 12px;
            color: #28a745;
            margin-left: 10px;
        }
        .friend-status.offline {
            color: #999;
        }
        .friend-checkbox {
            transform: scale(1.2);
            accent-color: #6c5ce7;
        }
        #invite-modal .modal-content button {
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 600;
        }
        #final-invite-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        .inline-profile-detail {
            position: fixed;
            top: 100px;
            right: 280px;
            width: 200px;
            height: auto;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: none;
            flex-direction: column;
            z-index: 9999;
            border: 1px solid #ddd;
        }
        .inline-profile-detail.open {
            transform: translateX(0%);
            display: flex;
        }
        .inline-profile-detail .close-profile-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .profile-detail-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #6c5ce7;
        }
        .profile-info-content h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .profile-meta-info p {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
        }
        .profile-meta-info strong {
            font-size: 13px;
        }
        .chat-one-on-one-btn, .send-friend-request-btn {
            padding: 8px 10px;
            margin-top: 8px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        .chat-content-area.profile-open {
            padding-left: 0;
        }
        .room-title-wrapper {
            display: flex;
            align-items: center;
        }
        .room-status-info {
            font-size: 13px;
            font-weight: 500;
            color: #6c5ce7;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .room-status-info .fa-lock { color: #e74c3c; }
        .room-status-info .fa-users { color: #6c5ce7; }
        .room-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .unread-badge {
            background-color: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            padding: 3px 8px;
            flex-shrink: 0;
            min-width: 24px;
            text-align: center;
        }
        .invite-action-btn {
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            transition: background-color 0.3s, transform 0.2s;
        }
        .invite-action-btn:hover {
            transform: translateY(-1px);
            background-color: #27ae60 !important;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li class="active"><a href="/chat" class="active"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
        </ul>
    </nav>
</header>

<div id="connection-status">
    WebSocket ì—°ê²° ì¤‘... ì„œë²„ê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
</div>

<main id="chat-main-wrapper" class="chat-main">
    <div class="chat-sidebar">
        <div class="chat-header">
            ì±„íŒ… ëª©ë¡
            <button id="new-chat-btn" onclick="openNewChatModal(true)" style="background:none; border:none; color:#6c5ce7; font-size:16px; cursor:pointer;" title="ìƒˆ ì±„íŒ… ì‹œì‘">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>

        <div id="chat-type-tabs" class="chat-type-tabs">
            <button data-type="group">ê·¸ë£¹ ì±„íŒ…</button>
            <button data-type="one-on-one">1:1 ì±„íŒ…</button>
        </div>

        <div id="room-list-container" class="room-list-container">
        </div>
    </div>

    <div class="chat-content-area">
        <div id="chat-welcome-message">
            <p>ì±„íŒ… ëª©ë¡ì—ì„œ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>

        <div id="current-chat-room">
            <div id="chat-room-header" class="chat-header">
                <div class="room-title-wrapper">
                    <span id="room-title">ì±„íŒ…ë°© ì œëª©</span>
                    <div id="room-status-display" class="room-status-info">
                        <span id="room-type-icon"></span>
                        <span id="room-participant-count">0/0</span>
                    </div>
                </div>
                <button onclick="openParticipantList()" style="background:none; border:none; color:#6c5ce7; font-size:18px; cursor:pointer;" title="ì°¸ì—¬ì ëª©ë¡">
                    <i class="fas fa-users"></i>
                </button>
            </div>

            <div id="inline-profile-detail" class="inline-profile-detail">
                <button class="close-profile-btn" onclick="openInlineProfileDetail(false)">&times;</button>
                <div class="profile-info-content" style="text-align: center;">
                    <div style="margin-bottom: 10px; padding-top: 5px;">
                        <img id="profile-img-detail" src="/images/default-profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-detail-img">
                        <h3 id="profile-nickname-detail">ë‹‰ë„¤ì„</h3>
                    </div>
                    <div class="profile-meta-info" style="border-top: 1px solid #eee; padding-top: 10px;">
                        <p style="font-weight: 500;">ì¥ì†Œ: <strong id="profile-location-detail">...</strong></p>
                        <p style="font-weight: 500;">í¬ì§€ì…˜: <strong id="profile-position-detail">...</strong></p>
                    </div>
                    <button class="chat-one-on-one-btn profile-action-button" id="profile-chat-btn">1:1 ì±„íŒ…í•˜ê¸°</button>
                    <button class="send-friend-request-btn profile-action-button" id="profile-friend-btn">ì¹œêµ¬ ìš”ì²­</button>
                </div>
            </div>

            <div id="chat-messages-container" class="chat-messages">
            </div>

            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode===13) sendMessage()" maxlength="500">
                <button onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>

    </div>
</main>

<div id="participant-sidebar">
    <div class="sidebar-header">
        <span id="sidebar-room-name">ì°¸ì—¬ì ëª©ë¡</span>
        <button class="sidebar-close-btn" onclick="openParticipantList(false)">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="participant-list-container" class="participant-list-container">
    </div>
    <div style="padding: 15px; border-top: 1px solid #eee;">
        <button class="btn-create invite-action-btn" style="width: 100%;" onclick="openInviteModal()">
            <i class="fas fa-user-plus"></i> ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°
        </button>
    </div>
</div>

<div id="new-chat-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ìƒˆ ì±„íŒ…ë°© ì‹œì‘</h2>

        <label for="new-chat-type">ì±„íŒ…ë°© ìœ í˜• ì„ íƒ</label>
        <select id="new-chat-type" onchange="updateNewChatForm(this.value)">
            <option value="one-on-one" selected>1:1 ì±„íŒ…</option>
            <option value="group">ê·¸ë£¹ ì±„íŒ…</option>
        </select>

        <div id="max-participants-group" style="display: none;">
            <label for="new-chat-max-participants" style="margin-top: 10px;">ìµœëŒ€ ì°¸ì—¬ ì¸ì› (ê·¸ë£¹ ì±„íŒ…)</label>
            <input type="number" id="new-chat-max-participants" min="3" max="50" value="10">
        </div>
        <label for="new-chat-title" style="margin-top: 10px;">ì±„íŒ…ë°© ì´ë¦„</label>
        <input type="text" id="new-chat-title" placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

        <div id="recipient-input-group">
            <label for="new-chat-recipient" style="margin-top: 10px;">ìƒëŒ€ë°© ë‹‰ë„¤ì„ (1:1 ì±„íŒ…)</label>
            <input type="text" id="new-chat-recipient" placeholder="ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <p id="chat-form-info" style="font-size: 13px; color: #777; margin-bottom: 20px;">1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.</p>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="openNewChatModal(false)">ì·¨ì†Œ</button>
            <button class="btn-create" onclick="createNewChat()">ì±„íŒ… ì‹œì‘</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2 id="profile-username-title">ì‚¬ìš©ì í”„ë¡œí•„</h2>
        <div id="profile-details-content">
            <p>ë‹‰ë„¤ì„: <strong id="profile-nickname">...</strong></p>
            <p>í¬ì§€ì…˜: <strong id="profile-position">...</strong></p>
            <p>ì§€ì—­: <strong id="profile-location">...</strong></p>
            <p style="margin-top: 15px; font-size: 14px; color: #e74c3c;">
                (ì‹¤ì œ DB ì •ë³´ ì—°ë™ í•„ìš”)
            </p>
        </div>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-cancel" onclick="openProfileModal(false)">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="invite-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ì¹œêµ¬ ì´ˆëŒ€</h2>
        <p id="invite-room-info">í˜„ì¬ ë°©: <strong id="invite-room-name">...</strong> (ì¸ì› ì œí•œ: <span id="invite-count-info">...</span>)</p>

        <div id="friend-list-to-invite">
        </div>

        <div class="modal-actions" style="justify-content: space-between;">
            <p style="font-size: 14px; color: #555; margin: 0; align-self: center;">
                <span id="selected-invite-count">0</span>ëª… ì„ íƒë¨
            </p>
            <div>
                <button class="btn-cancel" onclick="openInviteModal(false)">ì·¨ì†Œ</button>
                <button class="btn-create" id="final-invite-btn" onclick="sendInvite()">ì´ˆëŒ€í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // --- [ìˆ˜ì •ëœ] ë©”ë‰´ ë° í”„ë¡œí•„ í† ê¸€ ë¡œì§ ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navLoginLink = document.querySelector('#main-menu a[href="/login"]');
    const navLogoutLink = document.querySelector('#main-menu ul li:last-child');

    // â­â­ [ìˆ˜ì •] DOMContentLoaded ì´ì „ì— í—¤ë” ë‹‰ë„¤ì„ ë¡œë”© í•¨ìˆ˜ ì •ì˜ ë° ì‹¤í–‰ (ìµœìš°ì„  ì‹¤í–‰) â­â­
    (function loadHeaderNickname() {
        const usernameSpan = document.getElementById('user-menu-username');
        if (usernameSpan) {
            // 'userNickname' í‚¤ì˜ ê°’ì„ ê°€ì ¸ì™€ì„œ ì„¤ì •í•©ë‹ˆë‹¤.
            usernameSpan.textContent = localStorage.getItem('userNickname') || 'ì‚¬ìš©ì';
        }
    })();
    // â­â­ [ìˆ˜ì • ë] â­â­


    if (menuToggle) {
        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }

    // â­â­â­ [í•µì‹¬ ì¶”ê°€] ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë° ëª¨ë‹¬ ë‹«ê¸° ë¡œì§ â­â­â­
    const inlineProfileDetail = document.getElementById('inline-profile-detail');
    const newChatModal = document.getElementById('new-chat-modal');
    const profileModal = document.getElementById('profile-modal');
    const inviteModal = document.getElementById('invite-modal');

    document.addEventListener('click', (event) => {
        const isClickInsideMenu = mainMenu.contains(event.target) || menuToggle.contains(event.target);
        const isClickInsideProfile = profileMenu.contains(event.target) || profileMenuToggle.contains(event.target);

        // ì¸ë¼ì¸ í”„ë¡œí•„ ê´€ë ¨ (participant-item í´ë¦­ì€ openInlineProfileDetail ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë¨)
        const isClickInsideInlineProfile =
            inlineProfileDetail &&
            (inlineProfileDetail.contains(event.target) || event.target.closest('.participant-item'));

        const isNewChatButton = event.target.closest('#new-chat-btn');

        // ëª¨ë‹¬ ê´€ë ¨
        const isClickInsideNewChatModal = newChatModal.contains(event.target) || isNewChatButton;
        const isClickInsideProfileModal = profileModal.contains(event.target);
        const isClickInsideInviteModal = inviteModal.contains(event.target);

        // 1. ë©”ì¸ ë©”ë‰´ ë‹«ê¸°
        if (!isClickInsideMenu && mainMenu.classList.contains('show')) {
            mainMenu.classList.remove('show');
        }

        // 2. í”„ë¡œí•„ ë©”ë‰´ ë‹«ê¸°
        if (!isClickInsideProfile && profileMenu && profileMenu.classList.contains('show')) {
            profileMenu.classList.remove('show');
        }

        // 3. ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì°½ ë‹«ê¸°
        if (inlineProfileDetail && inlineProfileDetail.classList.contains('open') && !isClickInsideInlineProfile) {
            openInlineProfileDetail(false);
        }

        // 4. ëª¨ë‹¬ ì°½ ë‹«ê¸° (ëª¨ë‹¬ ì½˜í…ì¸  ìì²´ê°€ ì•„ë‹Œ ë°”ê¹¥ìª½ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ)
        if (newChatModal.classList.contains('open') && !isClickInsideNewChatModal) {
            openNewChatModal(false);
        }
        if (profileModal.classList.contains('open') && !isClickInsideProfileModal) {
            openProfileModal(false);
        }
        if (inviteModal.classList.contains('open') && !isClickInsideInviteModal) {
            openInviteModal(false);
        }

        // 5. ì‚¬ì´ë“œë°” ë‹«ê¸° (ì±„íŒ… ì˜ì—­ì„ í´ë¦­í–ˆì„ ë•Œ)
        const participantSidebar = document.getElementById('participant-sidebar');
        const isClickInsideSidebar = participantSidebar.contains(event.target) || event.target.closest('button[onclick="openParticipantList()"]');
        const isClickInsideChatContent = chatContentArea.contains(event.target) && !isClickInsideInlineProfile;

        if (participantSidebar.classList.contains('open') && isClickInsideChatContent && !isClickInsideSidebar) {
            openParticipantList(false);
        }
    });
    // --- [ìˆ˜ì •ëœ] ë©”ë‰´ ë° í”„ë¡œí•„ í† ê¸€ ë¡œì§ ë ---


    let stompClient = null;
    let currentRoomId = null;
    // â­ [ìˆ˜ì •] myUsernameì„ userNicknameìœ¼ë¡œ ì„¤ì •
    let myUsername = localStorage.getItem('userNickname') || 'MyUser123';
    const chatContainer = document.getElementById('chat-messages-container');
    const inputArea = document.getElementById('message-input');
    const roomTitleElement = document.getElementById('room-title');
    const connectionStatus = document.getElementById('connection-status');
    const roomListContainer = document.getElementById('room-list-container');
    const chatTypeTabs = document.getElementById('chat-type-tabs');
    const participantSidebar = document.getElementById('participant-sidebar');
    const participantListContainer = document.getElementById('participant-list-container');
    const chatMainWrapper = document.getElementById('chat-main-wrapper');
    const friendListToInvite = document.getElementById('friend-list-to-invite');
    const selectedInviteCountElement = document.getElementById('selected-invite-count');
    let selectedInvitees = new Set();

    const chatContentArea = document.querySelector('.chat-content-area');
    const roomStatusDisplay = document.getElementById('room-status-display');
    const roomParticipantCount = document.getElementById('room-participant-count');
    const roomTypeIcon = document.getElementById('room-type-icon');
    const profileChatBtn = document.getElementById('profile-chat-btn');
    const profileFriendBtn = document.getElementById('profile-friend-btn');

    const newChatTypeSelect = document.getElementById('new-chat-type');
    const newChatTitleInput = document.getElementById('new-chat-title');
    const newChatRecipientInput = document.getElementById('new-chat-recipient');
    const recipientInputGroup = document.getElementById('recipient-input-group');
    const chatFormInfo = document.getElementById('chat-form-info');

    const RECONNECT_INTERVAL = 5000;
    let currentChatType = 'group';
    let nextChatRoomId = 300;

    const MOCK_ROOMS = {
        'group': [
            // [ìˆ˜ì •] ì°¸ì—¬ì ëª©ë¡ì—ì„œ MyUser123 (ë°©ì¥)ì„ MyUser123 ë‹‰ë„¤ì„ + (ë°©ì¥) í˜•íƒœë¡œ ìœ ì§€
            { id: 1, name: 'âš½ 11/05 ìˆ˜ì› í’‹ì‚´ (10ëª…)', lastMessage: 'UserA: ë„¤, ê±°ê¸°ì„œ ë´¬ìš”!', participants: ['MyUser123 (ë°©ì¥)', 'UserA', 'UserB', 'UserC', 'UserD'], maxParticipants: 10, createdAt: '2025-10-28', unreadCount: 5 },
            { id: 2, name: 'ğŸ“Œ íŒ€ì› ëª¨ì§‘ - ìº¡í‹´ì†', lastMessage: 'ì¢‹ì•„ìš”, í¬ì§€ì…˜ì€ DF ê°€ëŠ¥í•©ë‹ˆë‹¤.', participants: ['MyUser123', 'ìº¡í‹´ì†', 'êµ¬ì›íˆ¬ìˆ˜'], maxParticipants: 12, createdAt: '2025-11-02', unreadCount: 0 }
        ],
        'one-on-one': [
            { id: 101, name: '1:1 ì±„íŒ… - ì‹¬íŒì¥ (ìš´ì˜ì§„)ë‹ˆ', lastMessage: 'ê·œì • ìœ„ë°˜ ê´€ë ¨ ë¬¸ì˜ ë‹µë³€ì…ë‹ˆë‹¤.', participants: ['MyUser123', 'ì‹¬íŒì¥ (ìš´ì˜ì§„)'], maxParticipants: 2, createdAt: '2025-09-01', unreadCount: 1 },
            { id: 102, name: '1:1 ì±„íŒ… - ìˆ˜ë¹„ìˆ˜ êµ¬í•¨', lastMessage: 'ì´ë²ˆ ì£¼ë§ ê²½ê¸° ê°€ëŠ¥í•˜ì„¸ìš”?', participants: ['MyUser123', 'ìˆ˜ë¹„ìˆ˜ êµ¬í•¨'], maxParticipants: 2, createdAt: '2025-11-03', unreadCount: 2 }
        ]
    };

    // âœ… ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ ì €ì¥/ë³µì›ìš© Key & í•¨ìˆ˜ë“¤
    const ROOM_STORAGE_KEY = 'chat_rooms_v1';

    function saveRoomsToStorage() {
        try {
            localStorage.setItem(ROOM_STORAGE_KEY, JSON.stringify(MOCK_ROOMS));
        } catch (e) {
            console.error('ì±„íŒ…ë°© ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', e);
        }
    }

    function loadRoomsFromStorage() {
        try {
            const raw = localStorage.getItem(ROOM_STORAGE_KEY);
            if (!raw) return;

            const parsed = JSON.parse(raw);

            if (parsed.group && Array.isArray(parsed.group)) {
                MOCK_ROOMS.group = parsed.group;
            }
            if (parsed['one-on-one'] && Array.isArray(parsed['one-on-one'])) {
                MOCK_ROOMS['one-on-one'] = parsed['one-on-one'];
            }

            // ì €ì¥ëœ ë°©ë“¤ ê¸°ì¤€ìœ¼ë¡œ nextChatRoomId ì¡°ì •
            let maxId = 0;
            Object.values(MOCK_ROOMS).forEach(roomArr => {
                roomArr.forEach(r => {
                    if (typeof r.id === 'number' && r.id > maxId) {
                        maxId = r.id;
                    }
                });
            });
            if (maxId >= 300) {
                nextChatRoomId = maxId + 1;
            }
        } catch (e) {
            console.error('ì±„íŒ…ë°© ì •ë³´ ë³µì› ì¤‘ ì˜¤ë¥˜:', e);
        }
    }

    const MOCK_HISTORY = {
        1: [
            { sender: 'UserA', content: 'ê²½ê¸° ì¥ì†Œ í˜¹ì‹œ ë³€ê²½ëœ ê±´ ì—†ë‚˜ìš”?', timestamp: 'ì˜¤ì „ 10:00' },
            { sender: 'MyUser123', content: 'ì•„ë‹™ë‹ˆë‹¤, ê·¸ëŒ€ë¡œ ì„œìš¸ ê°•ë‚¨ í’‹ì‚´ì¥ì…ë‹ˆë‹¤. ì‹œê°„ ë§ì¶° ì˜¤ì„¸ìš”!', timestamp: 'ì˜¤ì „ 10:05' }
        ],
        2: [
            { sender: 'OtherUser', content: 'íŒ€ì› ëª¨ì§‘ ë³´ê³  ì—°ë½ë“œë ¸ìŠµë‹ˆë‹¤. DF í¬ì§€ì…˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 1:00' },
            { sender: 'MyUser123', content: 'ì¢‹ìŠµë‹ˆë‹¤! ì´ë²ˆì£¼ í† ìš”ì¼ 19ì‹œ ì°¸ì„ ê°€ëŠ¥í•˜ì‹ ê°€ìš”?', timestamp: 'ì˜¤í›„ 1:05' }
        ],
        101: [
            { sender: 'ì‹¬íŒì¥ (ìš´ì˜ì§„)', content: 'ê·œì • ìœ„ë°˜ ê´€ë ¨ ë¬¸ì˜ ë‹µë³€ì…ë‹ˆë‹¤. í•´ë‹¹ ê±´ì€ ê²½ê³  ì¡°ì¹˜ë¡œ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 4:00' },
            { sender: 'MyUser123', content: 'ë¹ ë¥¸ ë‹µë³€ ê°ì‚¬í•©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 4:02' }
        ],
        102: [
            { sender: 'ìˆ˜ë¹„ìˆ˜ êµ¬í•¨', content: 'ì´ë²ˆ ì£¼ë§ ê²½ê¸° ê°€ëŠ¥í•˜ì„¸ìš”? ê¸‰í•˜ê²Œ í•œ ë¶„ êµ¬í•©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 7:00' },
            { sender: 'MyUser123', content: 'ì£„ì†¡í•©ë‹ˆë‹¤, ì´ë²ˆ ì£¼ë§ì€ ì„ ì•½ì´ ìˆì–´ìš”. ğŸ˜­', timestamp: 'ì˜¤í›„ 7:15' }
        ]
    };

    const MOCK_PROFILES = {
        'UserA': { nickname: 'UserA', position: 'FW', location: 'ì„œìš¸ ê°•ë‚¨êµ¬', profilePic: '/images/mock_user_a.png' },
        'UserB': { nickname: 'UserB', position: 'MF', location: 'ì„œìš¸ ì„œì´ˆêµ¬', profilePic: '/images/mock_user_b.png' },
        'ì‹¬íŒì¥ (ìš´ì˜ì§„)': { nickname: 'ìš´ì˜ì', position: 'GK', location: 'ì „êµ­', profilePic: '/images/mock_admin.png' },
        // â­ [ìˆ˜ì •] MyUser123 í”„ë¡œí•„ í‚¤ì— ë¡œì»¬ ë‹‰ë„¤ì„ ê°•ì œ ì„¤ì •
        'MyUser123': { nickname: localStorage.getItem('userNickname') || 'ë‚˜', position: 'DF', location: 'ì„œìš¸ ì¤‘êµ¬', profilePic: '/images/default-profile.png' },
        'ìº¡í‹´ì†': { nickname: 'ìº¡í‹´ì†', position: 'MF', location: 'ìˆ˜ì› ì˜í†µêµ¬', profilePic: '/images/mock_captain.png' },
        'êµ¬ì›íˆ¬ìˆ˜': { nickname: 'êµ¬ì›íˆ¬ìˆ˜', position: 'DF', location: 'ì„±ë‚¨ ë¶„ë‹¹êµ¬', profilePic: '/images/mock_closer.png' },
        'í’‹ì‚´ë§¤ë‹ˆì•„': { nickname: 'í’‹ì‚´ë§¤ë‹ˆì•„', position: 'ALA', location: 'ì¸ì²œ', profilePic: '/images/default-profile.png' },
        'ì¶•êµ¬ì™•': { nickname: 'ì¶•êµ¬ì™•', position: 'PIVO', location: 'ê°•ì›', profilePic: '/images/default-profile.png' },
    };

    const MOCK_FRIENDS = [
        { name: 'ìº¡í‹´ì†', status: 'ì˜¨ë¼ì¸' },
        { name: 'êµ¬ì›íˆ¬ìˆ˜', status: 'ì˜¤í”„ë¼ì¸' },
        { name: 'í’‹ì‚´ë§¤ë‹ˆì•„', status: 'ì˜¨ë¼ì¸' },
        { name: 'UserE', status: 'ì˜¨ë¼ì¸' },
        { name: 'UserF', status: 'ì˜¤í”„ë¼ì¸' }
    ];

    function updateStatus(message, isError = true) {
        connectionStatus.textContent = message;
        connectionStatus.style.display = 'block';
        connectionStatus.style.backgroundColor = isError ? '#ffe3e3' : '#e6ffed';
        connectionStatus.style.color = isError ? '#c0392b' : '#28a745';

        if (!isError) {
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        } else {
            connectionStatus.style.display = 'none';
            console.error("WebSocket ì—°ê²° ì‹¤íŒ¨. 5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
            return;
        }
    }

    function connect() {
        if (stompClient && stompClient.connected) {
            console.log('Already connected.');
            return;
        }

        updateStatus("WebSocket ì—°ê²° ì‹œë„ ì¤‘...", true);

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        console.log('WebSocket ì—°ê²° ì„±ê³µ.');
        updateStatus("âœ… ì‹¤ì‹œê°„ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", false);

        if (currentRoomId) {
            subscribeToRoom(currentRoomId);
        }
    }

    function onError(error) {
        console.error('WebSocket ì—°ê²° ì˜¤ë¥˜: ì¬ì—°ê²° ì‹œë„', error);
        connectionStatus.style.display = 'none';

        if (stompClient && stompClient.ws && stompClient.ws.readyState === WebSocket.OPEN) {
            stompClient.disconnect(() => {
                stompClient = null;
                setTimeout(connect, RECONNECT_INTERVAL);
            });
        } else {
            stompClient = null;
            setTimeout(connect, RECONNECT_INTERVAL);
        }
    }

    function subscribeToRoom(roomId) {
        if (stompClient && stompClient.connected) {
            stompClient.subscribe('/topic/chat/room/' + roomId, onMessageReceived);
            console.log(`Room ${roomId} êµ¬ë… ì‹œì‘.`);
        }
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        displayMessage(message);
    }

    function sendMessage() {
        const messageContent = inputArea.value.trim();
        if (messageContent && stompClient && stompClient.connected && currentRoomId) {
            const chatMessage = {
                roomId: currentRoomId,
                sender: myUsername,
                content: messageContent,
                timestamp: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            };

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            inputArea.value = '';
            displayMessage(chatMessage);
            updateLastMessage(currentRoomId, messageContent);

        } else if (!currentRoomId) {
            alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        } else if (!stompClient || !stompClient.connected) {
            alert("âŒ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„ í•´ì£¼ì„¸ìš”.");
        }
    }

    function updateLastMessage(roomId, content) {
        const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageDiv = roomItem.querySelector('.last-message');
            if (lastMessageDiv) {
                const preview = (content.length > 30 ? content.substring(0, 30) + '...' : content);
                lastMessageDiv.textContent = `ë‚˜: ${preview}`;
            }
        }
    }

    function displayMessage(message) {
        const isMine = message.sender === myUsername;
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');

        let senderName = isMine ? '' : message.sender;
        if (message.sender.includes("(ìš´ì˜ì§„)") || message.sender.includes("ê´€ë¦¬ì")) {
            senderName = `<span style="font-weight: 700; color: #6c5ce7;">${senderName}</span>`;
        } else if (message.sender.includes("(ë°©ì¥)")) {
            senderName = `<span style="font-weight: 700; color: #e74c3c;">${senderName}</span>`;
        }

        const meta = `<div class="message-meta">${message.timestamp}</div>`;
        const content = `<div class="message-content message-text">${senderName}${!isMine && senderName ? ': ' : ''}${message.content}</div>`;

        if (isMine) {
            bubble.innerHTML = meta + content;
        } else {
            bubble.innerHTML = content + meta;
        }

        chatContainer.appendChild(bubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function loadRoomList(type) {
        currentChatType = type;
        const rooms = MOCK_ROOMS[type] || [];
        roomListContainer.innerHTML = '';

        if (rooms.length === 0) {
            roomListContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">í˜„ì¬ ${type} ìœ í˜•ì˜ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            if (!rooms.find(room => room.id === currentRoomId)) {
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';
                roomStatusDisplay.style.display = 'none';
            }
            return;
        }

        rooms.forEach((room) => {
            const isActive = room.id === currentRoomId;
            const item = document.createElement('div');
            item.className = 'room-item' + (isActive ? ' active' : '');
            item.dataset.roomId = room.id;

            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';
            roomInfo.innerHTML = `
                <div class="room-name">${room.name}</div>
                <div style="font-size: 11px; color: #aaa; margin-top: 2px;">
                    ê°œì„¤ì¼: ${room.createdAt}
                </div>
                <div class="last-message">${room.lastMessage}</div>
            `;
            roomInfo.onclick = () => selectRoom(room);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-room-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`ì •ë§ë¡œ [${room.name}] ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    deleteChatRoom(room.id);
                }
            };

            const actionContainer = document.createElement('div');
            actionContainer.className = 'room-item-actions';

            if (room.unreadCount > 0) {
                actionContainer.innerHTML += `<span class="unread-badge">${room.unreadCount}</span>`;
            }
            actionContainer.appendChild(deleteBtn);

            item.appendChild(roomInfo);
            item.appendChild(actionContainer);
            roomListContainer.appendChild(item);
        });

        if (!currentRoomId) {
            document.getElementById('current-chat-room').style.display = 'none';
            document.getElementById('chat-welcome-message').style.display = 'flex';
        }
    }

    function deleteChatRoom(roomIdToDelete) {
        let roomDeleted = false;
        Object.keys(MOCK_ROOMS).forEach(type => {
            const initialLength = MOCK_ROOMS[type].length;
            MOCK_ROOMS[type] = MOCK_ROOMS[type].filter(room => room.id !== roomIdToDelete);
            if (MOCK_ROOMS[type].length < initialLength) {
                roomDeleted = true;
            }
        });

        if (roomDeleted) {
            delete MOCK_HISTORY[roomIdToDelete];
            alert('ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            if (currentRoomId === roomIdToDelete) {
                currentRoomId = null;
            }

            // âœ… ì‚­ì œ í›„ ì €ì¥
            saveRoomsToStorage();

            loadRoomList(currentChatType);
        }
    }

    function loadRoomHistory(roomId) {
        const id = parseInt(roomId);
        const history = MOCK_HISTORY[id] || [];

        chatContainer.innerHTML = '';

        if (history.length === 0) {
            chatContainer.innerHTML = `<div style="text-align: center; color: #999; margin-top: 50px;">ìƒˆë¡œìš´ ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”.</div>`;
        } else {
            history.forEach(msg => displayMessage(msg));
        }
    }

    function selectRoom(room) {
        const activeItem = document.querySelector('.room-item.active');
        if (activeItem) {
            activeItem.classList.remove('active');
            if(participantSidebar.classList.contains('open')) {
                openParticipantList(false);
            }
        }

        openInlineProfileDetail(false);

        const newActiveItem = document.querySelector(`.room-item[data-room-id="${room.id}"]`);
        if (newActiveItem) {
            newActiveItem.classList.add('active');
            const badge = newActiveItem.querySelector('.unread-badge');
            if(badge) badge.remove();
            room.unreadCount = 0;
        }

        currentRoomId = room.id;
        document.getElementById('sidebar-room-name').textContent = room.name;
        roomTitleElement.textContent = room.name;

        roomStatusDisplay.style.display = 'flex';
        roomParticipantCount.textContent = `${room.participants.length}/${room.maxParticipants}`;

        let iconClass = '';
        if (currentChatType === 'one-on-one') {
            iconClass = 'fas fa-lock';
        } else {
            iconClass = 'fas fa-users';
        }
        roomTypeIcon.innerHTML = `<i class="${iconClass}"></i>`;

        const chatHeader = document.getElementById('chat-room-header');
        if (!chatHeader.querySelector('.room-title-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'room-title-wrapper';
            wrapper.appendChild(roomTitleElement);
            wrapper.appendChild(roomStatusDisplay);
            chatHeader.prepend(wrapper);
        }

        document.getElementById('chat-welcome-message').style.display = 'none';
        document.getElementById('current-chat-room').style.display = 'flex';
        document.getElementById('current-chat-room').style.flexDirection = 'column';

        loadRoomHistory(room.id);

        if (stompClient && stompClient.connected) {
            subscribeToRoom(room.id);
        } else {
            connect();
        }
    }

    function openParticipantList(shouldOpen) {
        const isOpen = typeof shouldOpen === 'boolean' ? shouldOpen : !participantSidebar.classList.contains('open');

        if (isOpen) {
            loadParticipantList(currentRoomId);
            participantSidebar.classList.add('open');
            chatMainWrapper.classList.add('sidebar-open');
            openInlineProfileDetail(false);
        } else {
            participantSidebar.classList.remove('open');
            chatMainWrapper.classList.remove('sidebar-open');
        }
    }

    function loadParticipantList(roomId) {
        const roomsOfType = MOCK_ROOMS[currentChatType];
        const room = roomsOfType ? roomsOfType.find(r => r.id === parseInt(roomId)) : null;

        participantListContainer.innerHTML = '';

        if (!room || !room.participants) {
            participantListContainer.innerHTML = '<p style="color: #999; text-align: center;">ì°¸ì—¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        document.getElementById('sidebar-room-name').textContent = `${room.name} (${room.participants.length}ëª…)`;

        room.participants.forEach(participant => {
            const item = document.createElement('div');
            item.className = 'participant-item';

            let iconClass = 'fas fa-user-circle';
            let roleBadge = '';

            if (participant.includes('(ìš´ì˜ì§„)') || participant.includes('ê´€ë¦¬ì')) {
                iconClass = 'fas fa-shield-alt';
                roleBadge = '<span class="participant-role-badge role-admin">ìš´ì˜ì§„</span>';
            } else if (participant.includes('(ë°©ì¥)')) {
                iconClass = 'fas fa-crown';
                roleBadge = '<span class="participant-role-badge role-host">ë°©ì¥</span>';
            }
            if (participant.includes(myUsername)) {
                if (!roleBadge) {
                    roleBadge = '<span class="participant-role-badge role-me">ë‚˜</span>';
                } else {
                    roleBadge += '<span class="participant-role-badge role-me">ë‚˜</span>';
                }
            }

            let displayName = participant.replace(/\s\(.*\)/g, '');

            // â­ [ìˆ˜ì •] Host/ë‚˜ì¼ ê²½ìš° ë‹‰ë„¤ì„ìœ¼ë¡œ ë®ì–´ì“°ê¸°
            if (displayName === 'MyUser123' && (participant.includes('(ë°©ì¥)') || participant.includes(myUsername))) {
                displayName = myUsername; // 'ë¦¬ì–¼ìœ ì €'
            }

            item.onclick = () => openInlineProfileDetail(displayName);

            item.innerHTML = `
                <div class="participant-icon-wrapper">
                    <i class="${iconClass}"></i>
                </div>
                <div class="participant-details">
                    <span class="participant-name">${displayName}${roleBadge}</span>
                </div>
            `;
            participantListContainer.appendChild(item);
        });
    }

    function openInlineProfileDetail(username) {
        const isCurrentlyOpen = inlineProfileDetail.classList.contains('open');

        if (username === false || (isCurrentlyOpen && inlineProfileDetail.dataset.username === username)) {
            inlineProfileDetail.classList.remove('open');
            inlineProfileDetail.style.display = 'none';
            delete inlineProfileDetail.dataset.username;
            return;
        }

        let profileKey = username;
        // â­ [ìˆ˜ì •] ë‚´ ë‹‰ë„¤ì„ì´ MyUser123 ë‹‰ë„¤ì„ê³¼ ê°™ë‹¤ë©´, MOCK_PROFILES í‚¤ë¥¼ MyUser123ë¡œ ì„¤ì •
        if (username === myUsername) {
            profileKey = 'MyUser123';
        }

        const profile = MOCK_PROFILES[profileKey] ||
            { nickname: username, position: 'ë¯¸ë“±ë¡', location: 'ë¯¸ë“±ë¡', profilePic: '/images/default-profile.png' };

        inlineProfileDetail.dataset.username = username;

        document.getElementById('profile-img-detail').src = profile.profilePic || '/images/default-profile.png';
        document.getElementById('profile-nickname-detail').textContent = profile.nickname;
        document.getElementById('profile-location-detail').textContent = profile.location;
        document.getElementById('profile-position-detail').textContent = profile.position;

        inlineProfileDetail.style.display = 'flex';
        inlineProfileDetail.classList.add('open');
    }

    function openNewChatModal(open, recipientUsername = null) {
        if (open) {
            newChatModal.classList.add('open');
            newChatTitleInput.value = '';
            newChatTypeSelect.value = 'one-on-one';
            updateNewChatForm('one-on-one');

            if (recipientUsername) {
                newChatRecipientInput.value = recipientUsername;
            } else {
                newChatRecipientInput.value = '';
            }

            newChatTitleInput.focus();
        } else {
            newChatModal.classList.remove('open');
        }
    }

    function updateNewChatForm(type) {
        const maxParticipantsGroup = document.getElementById('max-participants-group');
        const recipientLabel = document.querySelector('label[for="new-chat-recipient"]');

        if (type === 'one-on-one') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'none';
            chatFormInfo.textContent = '1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.';
            newChatRecipientInput.placeholder = '1:1 ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”';
            recipientLabel.textContent = 'ìƒëŒ€ë°© ë‹‰ë„¤ì„ (1:1 ì±„íŒ…)';
        } else if (type === 'group') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'block';
            chatFormInfo.textContent = 'ê·¸ë£¹ ì±„íŒ…ì— ì´ˆëŒ€í•  ì°¸ì—¬ì ë‹‰ë„¤ì„ì„ ì‰¼í‘œ(,)ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­).';
            newChatRecipientInput.placeholder = 'ì´ˆëŒ€í•  ë‹‰ë„¤ì„ ì…ë ¥ (ì„ íƒ ì‚¬í•­)';
            recipientLabel.textContent = 'ì°¸ì—¬ì ì´ˆëŒ€ (ê·¸ë£¹ ì±„íŒ…)';
        }

        newChatRecipientInput.value = '';
    }

    function createNewChat() {
        const type = newChatTypeSelect.value;
        const title = newChatTitleInput.value.trim();
        const recipientInput = newChatRecipientInput.value.trim();
        const maxParticipantsInput = document.getElementById('new-chat-max-participants');

        if (!title) {
            alert("ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        let newRoomName = title;
        let newParticipants = [myUsername];
        let maxCount;

        if (type === 'one-on-one') {
            if (!recipientInput) {
                alert("1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }
            const recipient = recipientInput.split(',')[0].trim();
            newRoomName = `1:1 ì±„íŒ… - ${recipient} (vs ${myUsername})`;
            newParticipants = [myUsername, recipient];

            const existingRoom = MOCK_ROOMS['one-on-one'].find(room =>
                room.participants.includes(recipient) && room.participants.includes(myUsername)
            );
            if (existingRoom) {
                alert(`${recipient}ë‹˜ê³¼ì˜ ì±„íŒ…ë°©ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                openNewChatModal(false);
                selectRoom(existingRoom);
                return;
            }
            maxCount = 2;

        } else if (type === 'group') {
            newRoomName = `[ê·¸ë£¹] ${title}`;
            if (recipientInput) {
                const recipients = recipientInput.split(',').map(r => r.trim()).filter(r => r);
                newParticipants = [myUsername + ' (ë°©ì¥)', ...recipients];
            } else {
                newParticipants = [myUsername + ' (ë°©ì¥)'];
            }
            maxCount = parseInt(maxParticipantsInput.value) || 10;
            if (maxCount < 3) maxCount = 3;
        }

        const newRoomId = nextChatRoomId++;
        const newRoom = {
            id: newRoomId,
            name: newRoomName,
            lastMessage: 'ìƒˆë¡œìš´ ì±„íŒ…ë°©ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
            participants: newParticipants,
            maxParticipants: maxCount,
            createdAt: new Date().toISOString().slice(0, 10),
            unreadCount: 0
        };

        MOCK_ROOMS[type].unshift(newRoom);
        MOCK_HISTORY[newRoomId] = [{
            sender: 'System',
            content: newRoomName + 'ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
            timestamp: new Date().toLocaleTimeString('ko-KR')
        }];

        // âœ… ìƒˆ ë°© ìƒì„± í›„ ì €ì¥
        saveRoomsToStorage();

        openNewChatModal(false);

        chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        const newTab = document.querySelector(`[data-type="${type}"]`);
        if (newTab) newTab.classList.add('active');

        loadRoomList(type);
        selectRoom(newRoom);
    }

    function openProfileModal(username) {
        console.warn("openProfileModal ëŒ€ì‹  openInlineProfileDetailì„ ì‚¬ìš©í•˜ì„¸ìš”.");
        if (username === false) {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('open');
        }
    }

    function openInviteModal(open = true) {
        const currentRoom = MOCK_ROOMS[currentChatType].find(r => r.id === currentRoomId);

        if (currentRoomId === null || !currentRoom) {
            alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (open) {
            const currentCount = currentRoom.participants.length;
            const maxCount = currentRoom.maxParticipants;
            const availableSlots = maxCount - currentCount;

            if (currentChatType === 'one-on-one' || availableSlots <= 0) {
                alert('ì´ ë°©ì€ í˜„ì¬ ì´ˆëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (1:1 ì±„íŒ… ë˜ëŠ” ì •ì› ì´ˆê³¼)');
                return;
            }

            document.getElementById('invite-room-name').textContent = currentRoom.name;
            document.getElementById('invite-count-info').textContent = `ìµœëŒ€ ${maxCount}ëª… ì¤‘ ${availableSlots}ëª… ì¶”ê°€ ê°€ëŠ¥`;

            loadFriendListForInvite(currentRoom);

            selectedInvitees.clear();
            selectedInviteCountElement.textContent = 0;

            inviteModal.classList.add('open');
        } else {
            inviteModal.classList.remove('open');
        }
    }

    function loadFriendListForInvite(currentRoom) {
        const currentParticipantsNames = currentRoom.participants.map(p => p.split(' ')[0]);
        friendListToInvite.innerHTML = '';

        const availableSlots = currentRoom.maxParticipants - currentRoom.participants.length;

        MOCK_FRIENDS
            .filter(friend =>
                friend.name !== myUsername.split(' ')[0] &&
                !currentParticipantsNames.includes(friend.name)
            )
            .forEach(friend => {
                const item = document.createElement('div');
                item.className = 'invite-friend-item';
                item.dataset.friendName = friend.name;

                const isAvailable = friend.status === 'ì˜¨ë¼ì¸';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'friend-checkbox';
                checkbox.disabled = !isAvailable || selectedInvitees.size >= availableSlots;
                checkbox.checked = selectedInvitees.has(friend.name);

                checkbox.onchange = function() {
                    toggleInviteSelection(friend.name, item, this.checked);
                };

                const nameSpan = document.createElement('span');
                nameSpan.innerHTML = `${friend.name}
                    <span class="friend-status ${isAvailable ? '' : 'offline'}">(${friend.status})</span>`;

                item.appendChild(checkbox);
                item.appendChild(nameSpan);

                friendListToInvite.appendChild(item);
            });

        if (friendListToInvite.innerHTML === '') {
            friendListToInvite.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">ì´ˆëŒ€í•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    function toggleInviteSelection(name, itemElement, isChecked) {
        const currentRoom = MOCK_ROOMS[currentChatType].find(r => r.id === currentRoomId);
        const availableSlots = currentRoom.maxParticipants - currentRoom.participants.length;

        if (isChecked) {
            if (selectedInvitees.size < availableSlots) {
                selectedInvitees.add(name);
                itemElement.classList.add('selected');
            } else {
                itemElement.querySelector('.friend-checkbox').checked = false;
                alert(`ìµœëŒ€ ${availableSlots}ëª…ê¹Œì§€ë§Œ ì´ˆëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }
        } else {
            selectedInvitees.delete(name);
            itemElement.classList.remove('selected');
        }

        selectedInviteCountElement.textContent = selectedInvitees.size;

        const shouldDisable = selectedInvitees.size >= availableSlots;
        document.querySelectorAll('.invite-friend-item').forEach(item => {
            const checkbox = item.querySelector('.friend-checkbox');
            if (!checkbox.checked && shouldDisable) {
                checkbox.disabled = true;
            } else {
                const friendName = item.dataset.friendName;
                const friend = MOCK_FRIENDS.find(f => f.name === friendName);
                if (friend && friend.status === 'ì˜¨ë¼ì¸') {
                    checkbox.disabled = false;
                }
            }
        });
    }

    function sendInvite() {
        if (selectedInvitees.size === 0) {
            alert('ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ í•œ ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const inviteList = Array.from(selectedInvitees).join(', ');
        const currentRoom = MOCK_ROOMS[currentChatType].find(r => r.id === currentRoomId);

        console.log(`[ì´ˆëŒ€ ì „ì†¡ ì‹œë®¬ë ˆì´ì…˜] ë°© ID ${currentRoomId}ì— ${inviteList}ë¥¼ ì´ˆëŒ€í•©ë‹ˆë‹¤.`);

        alert(`${inviteList} ë‹˜ì—ê²Œ ì´ˆëŒ€ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬)`);

        currentRoom.participants.push(...Array.from(selectedInvitees).map(name => name));
        loadParticipantList(currentRoomId);

        // âœ… ì°¸ì—¬ì ë³€ê²½ í›„ ì €ì¥
        saveRoomsToStorage();

        openInviteModal(false);
    }

    // âœ… ê²½ê¸° ë§ˆê°ì—ì„œ ë„˜ì–´ì˜¨ ì •ë³´ë¡œ ê·¸ë£¹ ì±„íŒ…ë°© ìë™ ìƒì„±
    function createGroupChatFromMatch(matchChatData) {
        if (!matchChatData) return;
        if (matchChatData.type !== 'group') return;

        const newRoomId = nextChatRoomId++;

        const hostName = myUsername + ' (ë°©ì¥)';
        const otherParticipants = (matchChatData.participants || []).filter(n => n && n !== myUsername);

        const newRoom = {
            id: newRoomId,
            name: matchChatData.title || `[ê²½ê¸°ì±„íŒ…] ${matchChatData.fromMatchId || ''}`,
            lastMessage: 'ê²½ê¸° ì°¸ê°€ì ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
            participants: [hostName, ...otherParticipants],
            maxParticipants: matchChatData.maxParticipants || 10,
            createdAt: new Date().toISOString().slice(0, 10),
            unreadCount: 0,

            // âœ… ì–´ë–¤ ê²½ê¸°ì—ì„œ ë§Œë“¤ì–´ì§„ ì±„íŒ…ë°©ì¸ì§€ ì €ì¥
            fromMatchId: matchChatData.fromMatchId || null
        };

        if (!MOCK_ROOMS['group']) {
            MOCK_ROOMS['group'] = [];
        }
        MOCK_ROOMS['group'].unshift(newRoom);

        MOCK_HISTORY[newRoomId] = [{
            sender: 'System',
            content: 'ê²½ê¸° ë§ˆê°ê³¼ í•¨ê»˜ ìƒì„±ëœ ì±„íŒ…ë°©ì…ë‹ˆë‹¤. ì¦ê²ê²Œ ëŒ€í™”í•´ ì£¼ì„¸ìš”! âš½',
            timestamp: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
        }];

        // âœ… ì €ì¥
        saveRoomsToStorage();

        chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        const groupTab = document.querySelector('[data-type="group"]');
        if (groupTab) groupTab.classList.add('active');

        currentChatType = 'group';

        loadRoomList('group');
        selectRoom(newRoom);
    }

    document.getElementById('room-list-container').addEventListener('click', (e) => {
    });

    chatTypeTabs.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button) {
            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const newType = button.dataset.type;
            loadRoomList(newType);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        // â­ [ìˆ˜ì •] 1:1 ì±„íŒ…í•˜ê¸° ë²„íŠ¼ ê¸°ëŠ¥ êµ¬í˜„
        const profileChatBtnElement = document.getElementById('profile-chat-btn');
        if (profileChatBtnElement) {
            profileChatBtnElement.addEventListener('click', function() {
                const username = inlineProfileDetail.dataset.username;
                openInlineProfileDetail(false);
                openNewChatModal(true, username);
            });
        }

        if (profileFriendBtn) {
            profileFriendBtn.addEventListener('click', function() {
                const username = inlineProfileDetail.dataset.username;
                alert(`${username}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.`);
                openInlineProfileDetail(false);
            });
        }

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        // âœ… localStorageì— ì €ì¥ëœ ì±„íŒ…ë°© ë¨¼ì € ë³µì›
        loadRoomsFromStorage();

        const defaultType = 'group';
        let activeTab = document.querySelector(`[data-type="${defaultType}"]`);

        chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        if (activeTab) activeTab.classList.add('active');

        currentChatType = defaultType;

        loadRoomList(currentChatType);
        updateNewChatForm('one-on-one');
        openInlineProfileDetail(false);

        // â­â­â­ [ì¶”ê°€] ì±„íŒ… ìƒì„± ë²„íŠ¼ ê¸°ëŠ¥ ì¬ë¶€ì°© â­â­â­
        const newChatBtn = document.getElementById('new-chat-btn');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // ì™¸ë¶€ í´ë¦­ ë‹«ê¸° ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€
                openNewChatModal(true);
            });
        }
        // â­â­â­ [ì¶”ê°€ ë] â­â­â­


        // âœ… ê²½ê¸° ìƒì„¸ì—ì„œ ë„˜ì–´ì˜¨ ê·¸ë£¹ ì±„íŒ… ìƒì„± ìš”ì²­ ì²˜ë¦¬
        const matchChatRaw = localStorage.getItem('match_chat_request');
        if (matchChatRaw) {
            try {
                const matchChatData = JSON.parse(matchChatRaw);
                createGroupChatFromMatch(matchChatData);
            } catch (e) {
                console.error('match_chat_request íŒŒì‹± ì¤‘ ì˜¤ë¥˜:', e);
            } finally {
                localStorage.removeItem('match_chat_request');
            }
        }
    });

    function updateGlobalBadge() {
        const hasNew = localStorage.getItem('hasNewNotification') === 'true';
        const badge = document.getElementById('notification-badge');
        if (badge) badge.style.display = hasNew ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const profileMenuToggle = document.getElementById('profile-menu-toggle');
        const profileMenu = document.getElementById('profile-menu');
        const logoutButton = document.getElementById('logout-button');
        const usernameSpan = document.getElementById('user-menu-username');

        const accessToken = localStorage.getItem('accessToken');
        if (accessToken) {
            profileMenuToggle.style.display = 'flex';
            // â­ [ìˆ˜ì •] ë‹‰ë„¤ì„ ë¡œë”© userNickname í‚¤ ì‚¬ìš©
            usernameSpan.textContent = localStorage.getItem('userNickname') || 'ì‚¬ìš©ì';
        }

        updateGlobalBadge();
    });

    window.addEventListener('storage', (e) => {
        if (e.key === 'hasNewNotification') updateGlobalBadge();
    });

    if (document.getElementById('logout-button')) {
        document.getElementById('logout-button').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            localStorage.removeItem('hasNewNotification');
            window.location.href = '/login';
        });
    }
</script>