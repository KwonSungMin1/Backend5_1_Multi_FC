<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - 마이페이지</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* 기존 스타일 유지 (생략) */
        .info-view-group { margin-bottom: 20px; }
        .info-view-group label { display: block; font-weight: 700; margin-bottom: 6px; color: #2c3e50; font-size: 14px; }
        .info-view-text { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #f7f7f7; color: #333; min-height: 47px; box-sizing: border-box; display: flex; align-items: center; }
        .info-view-profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #eee; margin-bottom: 15px; }

        /* --- 친구 관리 탭 스타일 --- */
        .tab-buttons.sub-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab-buttons.sub-tabs .sub-tab-btn { flex-grow: 1; padding: 10px 15px; background-color: #f0f0f0; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 15px; color: #555; transition: all 0.2s ease; margin-right: 5px; text-align: center; }
        .tab-buttons.sub-tabs .sub-tab-btn.active { background-color: #6c5ce7; color: white; border-color: #6c5ce7; position: relative; top: 1px; z-index: 1; }
        .sub-tab-content { display: none; padding: 20px 0; border-top: 1px solid #eee; }
        .sub-tab-content.active { display: block; }

        /* 친구 검색 그룹 (친구 목록 탭) */
        .friend-list-search-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .friend-list-search-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .friend-list-search-group button { padding: 10px 15px; background-color: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* 친구 목록 아이템 */
        .friend-item-list { list-style: none; padding: 0; margin: 0; }
        .friend-item-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fdfdfd;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s ease;
        }
        .friend-item-list li:hover {
            background-color: #f0f0f0;
        }
        .friend-item-list li.active {
            background-color: #e6e6ff;
            border-color: #6c5ce7;
        }
        .friend-item-list li strong {
            flex-grow: 1;
            color: #333;
            margin-right: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .action-buttons {
            display: none;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            gap: 8px;
            background-color: inherit;
            padding-left: 10px;
            z-index: 10;
        }
        .friend-item-list li.active .action-buttons {
            display: flex;
        }
        .action-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }
        .action-buttons .btn-chat {
            background-color: #4a90e2;
            color: white;
        }
        .action-buttons .btn-delete {
            background-color: #ff7675;
            color: white;
        }

        /* 친구 추가 탭 스타일 (기존 유지) */
        .friend-add-search-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .friend-add-search-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .friend-add-search-group button { padding: 10px 15px; background-color: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* ⭐⭐⭐ 친구 요청 목록 아이템 스타일 (클릭 가능 영역) ⭐⭐⭐ */
        .friend-request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fdfdfd;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s ease;
            list-style: none;
        }
        .friend-request-item:hover {
            background-color: #f0f0f0;
        }
        .friend-request-item.active {
            background-color: #e6e6ff; /* 활성화 배경색 */
            border-color: #6c5ce7;
        }

        /* 요청 액션 버튼 그룹 (토글) */
        .request-actions {
            display: none; /* 기본 숨김 */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            gap: 8px;
            z-index: 10;
        }
        .friend-request-item.active .request-actions {
            display: flex; /* active 시 표시 */
        }

        /* 버튼 스타일 */
        .request-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }
        .request-actions .btn-accept { background-color: #2ecc71; } /* 수락: 녹색 */
        .request-actions .btn-reject { background-color: #e74c3c; } /* 거절: 빨간색 */


        .friend-add-actions .btn-add-selected { padding: 10px 20px; background-color: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }

        /* ⭐⭐⭐ 마이페이지 고유 스타일 (유지) ⭐⭐⭐ */
        .score-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 15px;
            background: #e6e6ff;
            border-radius: 10px;
            overflow: hidden;
        }
        .score-item {
            text-align: center;
            font-size: 14px;
            color: #2c3e50;
            width: 50%;
            padding: 10px 10px;
            position: relative;
        }
        .score-item:first-child {
            background-color: rgba(108, 92, 231, 0.05);
            border-right: 1px solid #c0c0e0;
            border-radius: 8px 0 0 8px;
        }
        .score-item:last-child {
            background-color: rgba(46, 204, 113, 0.05);
            border-radius: 0 8px 8px 0;
            border-right: none;
        }
        .score-item .icon-box {
            font-size: 30px;
            color: #6c5ce7;
            margin-bottom: 5px;
            display: block;
        }
        .score-item strong {
            display: block;
            font-size: 24px;
            font-weight: 800;
            color: #2c3e50;
            margin-top: 5px;
        }

        /* 캘린더 이벤트 스타일: 경기일정/개인일정 구분 */
        .calendar-event.match-schedule {
            background-color: rgba(144, 77, 240, 0.7);
            border-left: 3px solid #9461e7;
            color: white;
            padding: 2px 4px;
            margin-top: 2px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 3px;
            cursor: pointer;
        }

        /* 개인 일정 (Personal Schedule): 파란색 계열 */
        .calendar-event.personal-schedule {
            background-color: rgba(74, 144, 226, 0.7);
            border-left: 3px solid #4a90e2;
            color: white;
            padding: 2px 4px;
            margin-top: 2px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 3px;
            cursor: pointer;
        }

        /* 달력 칸 높이 증가 (글씨 깨짐/두 줄 표시 해결) */
        .calendar-day-cell {
            height: 100px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            background-color: white;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .calendar-day-cell.today {
            border: 2px solid #ff7675;
            border-radius: 8px;
            background-color: #ffeaea;
            font-weight: bold;
        }
        .login-section#full-width-section {
            flex: 1 1 100%;
            max-width: 100%;
            padding-right: 50px !important;
        }
        .main-wrapper {
            width: 1000px;
            max-width: 95%;
        }

        /* 친구 관리 제목 스타일 및 아이콘 배치 */
        .friends-management-title-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .friends-management-title-wrapper h3 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
        }
        .friends-add-icon-btn {
            background: none;
            border: none;
            color: #6c5ce7;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        /* 캘린더 상세 창 (팝업 대신 고정 영역으로 사용) 스타일 */
        .fixed-schedule-list li {
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .fixed-schedule-list li:hover {
            opacity: 0.9;
        }
        .fixed-schedule-list li.active {
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            border: 1px solid #fff;
        }
        .fixed-schedule-list li.match-schedule { background-color: #9461e7; color: white; }
        .fixed-schedule-list li.personal-schedule { background-color: #4a90e2; color: white; }

        /* 캘린더 탭 레이아웃 조정 CSS */
        .calendar-layout-wrapper {
            display: flex;
            gap: 20px;
            flex-wrap: nowrap;
        }

        /* 캘린더 컨테이너의 너비를 제한하여 상세 창이 들어갈 공간을 만듭니다 */
        .calendar-container {
            flex-grow: 1;
            max-width: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* 캘린더 그리드 셀 크기 안정화 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        /* 캘린더 헤더 그리드에도 동일한 간격 적용 */
        #calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .calendar-header-cell {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: #555;
            background-color: #f8f8f8;
            border-radius: 5px;
        }

        /* 캘린더 상세 창 스타일 조정 */
        #fixed-schedule-detail {
            width: 300px;
            flex-shrink: 0;
            position: relative !important;
            top: auto !important;
            left: auto !important;
            transform: none !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        /* 닫기 버튼 스타일 */
        #close-detail-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            z-index: 10;
            padding: 5px;
        }

    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">사용자</span>님</strong>
                <p>환영합니다!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> 알림 목록</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> 프로필 수정</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
        </nav>
</header>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section" id="full-width-section">
            <div class="login-container">
                <h1 class="title-login">마이페이지</h1>

                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="tab-info">회원정보</button>
                    <button class="tab-btn" data-tab="tab-calendar">캘린더</button>
                    <button class="tab-btn" data-tab="tab-friends">친구 관리</button>
                </div>

                <div id="day-schedule-popup" style="display: none;"></div>

                <div id="tab-info" class="tab-content active">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 25px;">회원정보 확인</h3>

                    <div style="text-align: center; margin-bottom: 15px;">
                        <img id="profile-preview-view" th:src="@{/images/default-profile.png}" alt="프로필 사진" class="info-view-profile-pic">
                    </div>

                    <div class="score-display">
                        <div class="score-item">
                            <span class="icon-box"><i class="fas fa-running"></i></span>
                            실력 레벨
                            <strong id="view-skill-level">중급</strong>
                        </div>
                        <div class="score-item">
                            <span class="icon-box"><i class="fas fa-crosshairs"></i></span>
                            포지션
                            <strong id="view-position-score">픽소 (FIXO)</strong>
                        </div>
                    </div>

                    <div class="info-view-group">
                        <label>이메일</label>
                        <div id="view-email" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>아이디</label>
                        <div id="view-username" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>닉네임</label>
                        <div id="view-nickname" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>주소</label>
                        <div id="view-address" class="info-view-text">...</div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <a href="/profile/edit" id="edit-profile-button" class="login-button" style="text-decoration: none; padding: 12px 30px; font-size: 16px; width: auto; background: #6c5ce7; border-radius: 8px; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);">
                            <i class="fas fa-edit" style="margin-right: 5px;"></i> 회원정보 수정하기
                        </a>
                    </div>
                </div>

                <div id="tab-calendar" class="tab-content">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 20px;">내 일정</h3>
                    <a href="/schedule/add" id="add-schedule-btn" class="login-button" style="margin-bottom: 20px; padding: 12px; font-size: 16px; text-decoration: none; display: block; text-align: center;">
                        <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>새 일정 추가하기
                    </a>

                    <div class="calendar-layout-wrapper">

                        <div class="calendar-container">
                            <div class="calendar-header">
                                <nav class="calendar-nav">
                                    <button id="prev-month">&lt;</button>
                                </nav>
                                <h2 id="current-month-year">2025년 10월</h2>
                                <nav class="calendar-nav">
                                    <button id="next-month">&gt;</button>
                                </nav>
                            </div>
                            <div class="calendar-grid" id="calendar-days-header">
                                <div class="calendar-header-cell">일</div>
                                <div class="calendar-header-cell">월</div>
                                <div class="calendar-header-cell">화</div>
                                <div class="calendar-header-cell">수</div>
                                <div class="calendar-header-cell">목</div>
                                <div class="calendar-header-cell">금</div>
                                <div class="calendar-header-cell">토</div>
                            </div>
                            <div class="calendar-grid" id="calendar-days-grid"></div>
                        </div>

                        <div id="fixed-schedule-detail"
                             style="width: 300px; flex-shrink: 0; background: white; border: 1px solid #ddd; border-radius: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: none;">

                            <button id="close-detail-btn" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 20px; color: #999; cursor: pointer;">&times;</button>
                            <h3 id="detail-current-date" style="font-size: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 10px;">11월 05일 일정</h3>

                            <ul class="fixed-schedule-list" id="fixed-schedule-list" style="list-style: none; padding: 0; margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
                            </ul>

                            <h3 style="font-size: 16px; margin-top: 15px; font-weight: 700;">개인 일정 상세 정보</h3>

                            <div id="fixed-detail-edit-area" style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                                <input type="hidden" id="selected-schedule-id">
                                <input type="text" id="selected-schedule-name" placeholder="일정명" disabled style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd;">
                                <textarea id="selected-schedule-content" rows="4" placeholder="세부 내용을 입력하세요." disabled style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd;"></textarea>

                                <div style="text-align: right;">
                                    <button id="save-schedule-btn" disabled style="padding: 8px 15px; margin-left: 10px; background-color: #ccc; color: white; border: none; border-radius: 5px;">저장</button>
                                    <button id="delete-schedule-btn" disabled style="padding: 8px 15px; background-color: #ccc; color: white; border: none; border-radius: 5px;">삭제</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-friends" class="tab-content">

                    <div class="friends-management-title-wrapper">
                        <h3>친구 관리</h3>
                        <button class="friends-add-icon-btn" onclick="location.href='/friends'">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>

                    <div class="tab-buttons sub-tabs">
                        <button class="sub-tab-btn active" data-sub-tab="sub-tab-friend-list">친구 목록</button>
                        <button class="sub-tab-btn" data-sub-tab="sub-tab-friend-add">친구 요청</button>
                    </div>

                    <div id="sub-tab-friend-list" class="sub-tab-content active">
                        <p style="font-size: 14px; color: #6c5ce7; font-weight: 600; text-align: right; margin-bottom: 15px;">
                            총 <span id="friend-count-display">0</span>명
                        </p>

                        <div class="friend-list-search-group">
                            <input type="text" id="friend-list-search-input" placeholder="친구 닉네임 검색">
                            <button onclick="searchFriendList()">검색</button>
                        </div>

                        <ul id="friend-list" class="friend-item-list">
                        </ul>
                        <p id="no-friends-message" style="color: #777; text-align: center; padding: 20px; display: none;">
                            등록된 친구가 없습니다. '친구 요청' 탭에서 요청을 확인하세요.
                        </p>
                    </div>

                    <div id="sub-tab-friend-add" class="sub-tab-content">

                        <ul id="friend-add-search-results" class="friend-item-list">
                        </ul>

                        <div id="friend-request-message" style="border: 1px dashed #ddd; border-radius: 8px; padding: 15px; min-height: 100px; text-align: center; display: none; margin-top: 20px;">
                            <p style="color: #999;">새로운 친구 요청이 없습니다.</p>
                        </div>
                    </div>

                </div> </div>
        </div>
        <div class="background-image-section">
        </div>
    </div>
</main>

<script>
    // --- (★공통★) 메뉴 토글 및 로그아웃 로직 ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        const isClickInsideMainMenu = mainMenu.contains(event.target);
        const isClickInsideProfileMenu = profileMenu.contains(event.target);
        const isMenuToggle = menuToggle.contains(event.target);
        const isProfileToggle = profileMenuToggle.contains(event.target);
        if (!isClickInsideMainMenu && !isMenuToggle) { mainMenu.classList.remove('show'); }
        if (!isClickInsideProfileMenu && !isProfileToggle) { profileMenu.classList.remove('show'); }
    });
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            window.location.href = '/login';
        });
    }

    // --- 알림 배지 및 인증 상태 로직 ---
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;

    function updateGlobalBadge() {
        badge.style.display = (hasReviewNotif || hasScheduleNotif) ? 'block' : 'none';
    }

    async function checkPendingReviews() {
        await new Promise(r => setTimeout(r, 200));
        hasReviewNotif = localStorage.getItem('hasReadReviews') !== 'true';
    }
    async function checkUpcomingSchedules() {
        await new Promise(r => setTimeout(r, 500));
        hasScheduleNotif = true;
    }

    // --- 내 정보 (더미, ERD 반영) ---
    async function fetchMyInfo(token) {
        const myInfo = {
            email: "real.user@example.com",
            username: "RealUser123",
            nickname: "리얼유저",
            position: "픽소 (FIXO)",
            address: "서울시 서초구",
            skillLevel: "중급"
        };
        document.getElementById('view-email').textContent = myInfo.email;
        document.getElementById('view-username').textContent = myInfo.username;
        document.getElementById('view-nickname').textContent = myInfo.nickname;
        document.getElementById('view-address').textContent = myInfo.address;

        document.getElementById('view-position-score').textContent = myInfo.position;
        document.getElementById('view-skill-level').textContent = myInfo.skillLevel;
    }

    // --- 캘린더 (경기 일정, 오늘 날짜 강조, 현재 월 표시 로직) ---
    const monthYearElement = document.getElementById('current-month-year');
    const daysGrid = document.getElementById('calendar-days-grid');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');

    // ⭐⭐ 캘린더 상세 창 관련 변수 (와이어프레임 반영) ⭐⭐
    const fixedDetailWindow = document.getElementById('fixed-schedule-detail');
    const detailList = document.getElementById('fixed-schedule-list');
    const detailDateTitle = document.getElementById('detail-current-date');
    const saveBtn = document.getElementById('save-schedule-btn');
    const deleteBtn = document.getElementById('delete-schedule-btn');
    const scheduleNameInput = document.getElementById('selected-schedule-name');
    const scheduleContentInput = document.getElementById('selected-schedule-content');
    const selectedScheduleIdInput = document.getElementById('selected-schedule-id');
    const closeDetailBtn = document.getElementById('close-detail-btn'); // 닫기 버튼

    let currentDate = new Date();
    currentDate.setDate(1);

    // ⭐⭐ MOCK_SCHEDULES - ID 추가 및 데이터 정리
    let MOCK_SCHEDULES = [
        { id: 1, day: 5, time: "09:00", type: 'match', title: '09:00 경기 일정', detail: "장소: 강남 풋살장, 레벨: 중급, 인원: 10명" },
        { id: 2, day: 5, time: "13:00", type: 'personal', title: '13:00 개인 약속', detail: "축구화 세척 및 개인 연습 일정" },
        { id: 3, day: 25, time: "20:00", type: 'match', title: '수원 팀 매치', detail: "장소: 수원 월드컵 구장, 레벨: 고급" }
    ];

    // ⭐ [수정] 날짜 클릭 시 고정 상세 창 표시 함수 ⭐
    function openDaySchedule(day, event) {
        const schedulesToday = MOCK_SCHEDULES.filter(s => s.day === day);

        detailDateTitle.textContent = `${currentDate.getMonth() + 1}월 ${day}일 일정`;
        detailList.innerHTML = '';

        // 상세 수정 영역 초기화
        clearDetailEditArea();

        if (schedulesToday.length === 0) {
            detailList.innerHTML = '<li style="color: #999; text-align: center; padding: 10px;">이 날은 일정이 없습니다.</li>';
        } else {
            schedulesToday.forEach(schedule => {
                const li = document.createElement('li');
                const eventClass = schedule.type === 'match' ? 'match-schedule' : 'personal-schedule';

                li.className = eventClass;
                li.dataset.scheduleId = schedule.id;

                // ⭐ 리스트 아이템 스타일 ⭐
                li.style.cssText = `
                    background-color: ${eventClass === 'match-schedule' ? '#9461e7' : '#4a90e2'};
                    color: white;
                    padding: 8px 10px;
                    margin-bottom: 5px;
                    border-radius: 4px;
                `;

                li.innerHTML = `<span style="font-weight: 700;">${schedule.time}</span> ${schedule.title}`;

                // 목록 항목 클릭 시 상세 수정 영역에 바인딩
                li.onclick = (e) => bindScheduleToDetail(e, schedule);

                detailList.appendChild(li);
            });
        }

        // 고정 상세 창 표시
        fixedDetailWindow.style.display = 'block';

        event.stopPropagation();
    }

    // ⭐ [수정] 상세 수정 영역 초기화 함수 (새로운 ID에 맞춰 수정)
    function clearDetailEditArea() {
        scheduleNameInput.value = '';
        scheduleContentInput.value = '';
        selectedScheduleIdInput.value = '';

        // 버튼은 항상 보이되, 비활성화된 상태로 유지 (개인 일정 선택 시 활성화)
        saveBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';

        scheduleNameInput.disabled = true;
        scheduleContentInput.disabled = true;
        saveBtn.disabled = true;
        deleteBtn.disabled = true;
        saveBtn.style.backgroundColor = '#ccc';
        deleteBtn.style.backgroundColor = '#ccc';

        scheduleNameInput.placeholder = "일정을 선택하거나, 경기는 상세보기를 이용하세요.";
        scheduleContentInput.placeholder = "일정을 선택하거나, 경기는 상세보기를 이용하세요.";


        detailList.querySelectorAll('li').forEach(li => li.classList.remove('active'));
    }

    // ⭐ [수정] 일정 목록 클릭 시 상세 영역에 데이터 바인딩 함수 ⭐
    function bindScheduleToDetail(event, schedule) {

        // ⭐⭐⭐ [수정] 경기 일정 클릭 시 상세 페이지 이동 ⭐⭐⭐
        if (schedule.type === 'match') {
            window.location.href = `/schedule/detail/${schedule.id}`;
            return;
        }

        // 개인 일정일 경우만 수정 로직 진행
        clearDetailEditArea();
        event.currentTarget.classList.add('active');

        // 필드 초기화 및 바인딩
        scheduleNameInput.value = schedule.title;
        scheduleContentInput.value = schedule.detail;
        selectedScheduleIdInput.value = schedule.id;

        if (schedule.type === 'personal') {
            // 개인 일정 (Personal): 수정/삭제 가능
            scheduleNameInput.disabled = false;
            scheduleContentInput.disabled = false;
            saveBtn.disabled = false;
            deleteBtn.disabled = false;
            saveBtn.style.backgroundColor = '#4a90e2';
            deleteBtn.style.backgroundColor = '#e74c3c';
            scheduleNameInput.placeholder = "일정명 (수정 가능)";
            scheduleContentInput.placeholder = "세부 내용 (수정 가능)";
        }
    }

    // ⭐ [수정] 저장/수정 로직 ⭐
    saveBtn.addEventListener('click', function() {
        if(saveBtn.disabled) return;

        const id = selectedScheduleIdInput.value;
        const newTitle = scheduleNameInput.value.trim();
        const newDetail = scheduleContentInput.value.trim();

        if (!newTitle || !newDetail) {
            alert("일정명과 내용을 모두 입력해주세요.");
            return;
        }

        // MOCK_SCHEDULES 업데이트 시뮬레이션
        const targetIndex = MOCK_SCHEDULES.findIndex(s => s.id === parseInt(id));
        if (targetIndex !== -1) {
            MOCK_SCHEDULES[targetIndex].title = newTitle;
            MOCK_SCHEDULES[targetIndex].detail = newDetail;
            alert(`✅ 개인 일정이 수정되었습니다! ID: ${id}`);
            renderCalendar();
            fixedDetailWindow.style.display = 'none'; // 수정 후 창 닫기
        }
    });

    // ⭐ [수정] 삭제 로직 ⭐
    deleteBtn.addEventListener('click', function() {
        if(deleteBtn.disabled) return;

        if (confirm("정말로 이 일정을 삭제하시겠습니까?")) {
            const id = selectedScheduleIdInput.value;
            // MOCK_SCHEDULES에서 삭제 시뮬레이션
            const initialLength = MOCK_SCHEDULES.length;
            MOCK_SCHEDULES = MOCK_SCHEDULES.filter(s => s.id !== parseInt(id));

            if (MOCK_SCHEDULES.length < initialLength) {
                alert(`✅ 개인 일정이 삭제되었습니다! ID: ${id}`);
                renderCalendar();
                fixedDetailWindow.style.display = 'none'; // 삭제 후 창 닫기
            }
        }
    });

    function renderCalendar() {
        if (!daysGrid) return;

        daysGrid.innerHTML = '';

        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();


        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearElement.textContent = `${year}년 ${month + 1}월`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const cell = document.createElement('div');
            cell.classList.add('calendar-day-cell', 'other-month');
            daysGrid.appendChild(cell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement('div');
            cell.classList.add('calendar-day-cell');
            cell.textContent = day;

            if (year === currentYear && month === currentMonth && day === currentDayOfMonth) {
                cell.classList.add('today');
            }


            const schedulesToday = MOCK_SCHEDULES.filter(s => s.day === day);
            if (schedulesToday.length > 0) {
                schedulesToday.forEach(schedule => {
                    const eventDiv = document.createElement('div');

                    const eventClass = schedule.type === 'match' ? 'match-schedule' : 'personal-schedule';

                    eventDiv.className = `calendar-event ${eventDiv.className} ${eventClass}`;
                    eventDiv.textContent = schedule.time;
                    eventDiv.title = schedule.title;

                    eventDiv.onclick = (e) => e.stopPropagation();

                    cell.appendChild(eventDiv);
                });
            }
            // 날짜 셀 클릭 이벤트 연결 (openDaySchedule 호출)
            const dayToPass = day;
            cell.onclick = (e) => openDaySchedule(dayToPass, e);

            daysGrid.appendChild(cell);
        }
    }
    if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
        fixedDetailWindow.style.display = 'none';
    });
    if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
        fixedDetailWindow.style.display = 'none';
    });

    // ⭐⭐ [추가] 닫기 버튼 이벤트 리스너 ⭐⭐
    if (closeDetailBtn) {
        closeDetailBtn.addEventListener('click', () => {
            fixedDetailWindow.style.display = 'none';
        });
    }


    // --- 친구 요청 더미 데이터 ---
    let MOCK_FRIENDS = [
        { id: 101, name: 'User1', userId: 'user1_id' },
        { id: 102, name: 'User2', userId: 'user2_id' },
        { id: 103, name: '축구왕', userId: 'soccerKing_id' }
    ];
    let MOCK_REQUESTS = [
        { id: 1, name: 'RequestUserA', userId: 'requestA_id', type: 'received' },
        { id: 2, name: 'RequestUserB', userId: 'requestB_id', type: 'received' }
    ];

    // ⭐ [추가/수정] handleRequestItemClick 함수 (li 대신 div를 타겟으로 함) ⭐
    function handleRequestItemClick(event) {
        const clickedItem = event.currentTarget; // friend-request-item (div)

        if (event.target.closest('.request-actions')) {
            return;
        }

        const container = clickedItem.parentElement;

        container.querySelectorAll('.friend-request-item.active').forEach(item => {
            if (item !== clickedItem) {
                item.classList.remove('active');
            }
        });

        clickedItem.classList.toggle('active');
    }


    // --- 친구 목록 렌더링 함수 ---
    function renderFriendList() {
        const listContainer = document.getElementById('friend-list');
        const countDisplay = document.getElementById('friend-count-display');
        const messageContainer = document.getElementById('no-friends-message');
        const searchInput = document.getElementById('friend-list-search-input').value.toLowerCase();

        listContainer.innerHTML = '';
        const filteredFriends = MOCK_FRIENDS.filter(f => f.name.toLowerCase().includes(searchInput) || f.userId.toLowerCase().includes(searchInput));

        if (countDisplay) countDisplay.textContent = filteredFriends.length;

        if (filteredFriends.length === 0) {
            if(messageContainer) messageContainer.style.display = 'block';
            return;
        }
        if(messageContainer) messageContainer.style.display = 'none';

        filteredFriends.forEach(friend => {
            const li = document.createElement('li');
            li.dataset.friendId = friend.id;
            li.innerHTML = `
                <strong>${friend.name}</strong> (${friend.userId})
                <div class="action-buttons">
                    <button class="btn-chat" onclick="event.stopPropagation(); alert('${friend.name}님과 1:1 채팅 시작');">채팅</button>
                    <button class="btn-delete" onclick="event.stopPropagation(); deleteFriend(${friend.id}, '${friend.name}');">삭제</button>
                </div>
            `;
            li.onclick = () => {
                // 토글 active 클래스
                listContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
                li.classList.add('active');
            };
            listContainer.appendChild(li);
        });
    }

    // --- 친구 목록 검색 함수 ---
    function searchFriendList() {
        renderFriendList();
    }

    // --- 친구 삭제 더미 로직 ---
    function deleteFriend(id, name) {
        if (confirm(`${name}님을 친구 목록에서 삭제하시겠습니까?`)) {
            MOCK_FRIENDS = MOCK_FRIENDS.filter(f => f.id !== id);
            renderFriendList();
            alert(`${name}님이 삭제되었습니다.`);
        }
    }

    // --- 친구 요청 렌더링 함수 ---
    function renderFriendRequests() {
        const listContainer = document.getElementById('friend-add-search-results'); // ul 태그
        const messageContainer = document.getElementById('friend-request-message');
        listContainer.innerHTML = '';

        const receivedRequests = MOCK_REQUESTS.filter(r => r.type === 'received');

        if (receivedRequests.length === 0) {
            if(messageContainer) messageContainer.style.display = 'block';
            return;
        }
        if(messageContainer) messageContainer.style.display = 'none';

        receivedRequests.forEach(request => {
            const li = document.createElement('li'); // li 태그 사용
            li.className = 'friend-request-item';
            li.dataset.requestId = request.id;

            // ⭐⭐ 클릭 이벤트 리스너 연결 ⭐⭐
            li.onclick = handleRequestItemClick;

            li.innerHTML = `
                <span>${request.name} (${request.userId})</span>
                <div class="request-actions">
                    <button class="btn-accept" onclick="event.stopPropagation(); handleFriendRequest(${request.id}, '${request.name}', 'accept');"><i class="fas fa-check"></i> 수락</button>
                    <button class="btn-reject" onclick="event.stopPropagation(); handleFriendRequest(${request.id}, '${request.name}', 'reject');"><i class="fas fa-times"></i> 거절</button>
                </div>
            `;
            listContainer.appendChild(li);
        });
    }

    // --- 친구 요청 처리 더미 로직 ---
    function handleFriendRequest(id, name, action) {
        MOCK_REQUESTS = MOCK_REQUESTS.filter(r => r.id !== id);
        if (action === 'accept') {
            MOCK_FRIENDS.push({ id: id, name: name, userId: name.toLowerCase() + '_id' });
            alert(`${name}님의 친구 요청을 수락했습니다!`);
        } else {
            alert(`${name}님의 친구 요청을 거절했습니다.`);
        }
        renderFriendRequests();
        renderFriendList(); // 친구 목록 업데이트
    }

    // --- 서브 탭 로직 ---
    const subTabButtons = document.querySelectorAll('.sub-tabs .sub-tab-btn');
    const subTabContents = document.querySelectorAll('.sub-tab-content');
    subTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-sub-tab');
            subTabButtons.forEach(btn => btn.classList.remove('active'));
            subTabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');

            if (targetTab === 'sub-tab-friend-add') {
                renderFriendRequests();
            } else if (targetTab === 'sub-tab-friend-list') {
                renderFriendList();
            }
        });
    });

    // --- 메인 탭 로직 ---
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');

            // 탭 전환 시 상세 창 닫기
            fixedDetailWindow.style.display = 'none';
        });
    });


    // --- DOMContentLoaded 초기화 로직 (유지 및 수정) ---
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("로그인이 필요한 페이지입니다.");
            window.location.href = '/login';
        } else {
            profileMenuToggle.style.display = 'block';
            await checkPendingReviews();
            await checkUpcomingSchedules();
            updateGlobalBadge();
            fetchMyInfo(accessToken);

            const calendarGrid = document.getElementById('calendar-days-grid');
            if (calendarGrid) {
                renderCalendar();
            }

            // 페이지 로드 시 '회원정보' 탭을 기본으로 설정 (URL 파라미터 처리)
            const urlParams = new URLSearchParams(window.location.search);
            const mainTab = urlParams.get('tab');
            const subTab = urlParams.get('subtab');

            if (mainTab && mainTab === 'friends') {
                document.querySelector('.tab-btn[data-tab="tab-friends"]').click();
                if (subTab && subTab === 'add') {
                    document.querySelector('.sub-tab-btn[data-sub-tab="sub-tab-friend-add"]').click();
                } else {
                    document.querySelector('.sub-tab-btn[data-sub-tab="sub-tab-friend-list"]').click();
                }
            } else {
                // 기본 '회원정보' 탭 활성화
                document.querySelector('.tab-btn[data-tab="tab-info"]').classList.add('active');
                document.getElementById('tab-info').classList.add('active');
            }
            // 친구 관리 탭이 활성화되지 않은 경우에도 친구 목록은 초기화
            renderFriendList();
        }
    });

</script>
</body>
</html>