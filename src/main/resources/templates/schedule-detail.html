<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²½ê¸° ìƒì„¸ (ID: ' + ${matchId} + ') - MULTI FC'">Multi FC - ì¼ì • ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .schedule-search-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .search-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }

        .search-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .delete-match-btn {
            padding: 8px 14px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background-color: #6c5ce7;
            color: #fff;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .delete-match-btn:hover {
            background-color: #c0392b;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr 350px;
            }
        }

        .map-area {
            width: 100%;
            height: 300px;
            background-color: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #888;
        }
        .detail-info-item {
            display: flex;
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            align-items: center;
        }
        .detail-info-item i {
            width: 30px;
            color: #6c5ce7;
            font-size: 18px;
        }
        .status-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
        }
        .status-card h3 {
            font-size: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .participant-section {
            margin-top: 10px;
        }
        .host-participant-list {
            margin: 0;
            padding: 0 0 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .participant-scroll {
            max-height: 320px;
            overflow-y: auto;
            padding-top: 8px;
        }

        .participant-list {
            list-style: none;
            padding: 0;
        }
        .participant-list li {
            padding: 8px 0;
            color: #555;
            font-size: 15px;
            border-bottom: 1px dashed #eee;
        }
        .participant-list li:last-child {
            border-bottom: none;
        }
        .participant-list .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            gap: 8px;
        }
        .participant-list .user-main {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .participant-list .user-main input[type="checkbox"] {
            cursor: pointer;
        }
        .participant-list .user-info .role-badge {
            font-size: 12px;
            background: #e74c3c;
            color: white;
            padding: 2px 5px;
            border-radius: 5px;
            font-weight: 400;
        }
        .participant-list .detail-info {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        .join-button {
            width: 100%;
            padding: 14px;
        }
        .btn-cancel {
            background-color: #e74c3c;
        }

        #host-select-hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        #close-match-btn {
            background-color: #ccc !important;
            cursor: not-allowed;
        }
        #close-match-btn.enabled:not(:disabled) {
            background-color: #6c5ce7 !important;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li style="display:none;"><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>
</header>

<main class="schedule-search-main">
    <div class="search-container">

        <div class="search-title-bar">
            <h1 class="search-title" th:text="'ê²½ê¸° ìƒì„¸ ì •ë³´ (ID: ' + ${matchId} + ')'">ğŸ“… ì¼ì • ìƒì„¸</h1>
            <button id="delete-match-btn" class="delete-match-btn" style="display:none;">
                ê²½ê¸° ì œê±°
            </button>
        </div>

        <input type="hidden" id="match-id-hidden" th:value="${matchId}">

        <div class="detail-grid">

            <div class="detail-left-column">
                <div class="map-area" id="map">(KakaoMap APIê°€ í‘œì‹œë  ì˜ì—­)</div>

                <h3>ê²½ê¸° ì •ë³´</h3>
                <div class="detail-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="detail-datetime"></span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="detail-location"></span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-users"></i>
                    <span id="detail-match-type">ê°œì¸ ë§¤ì¹­ (10ëª… ëª¨ì§‘)</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-medal"></i>
                    <span id="detail-skill-level">ì¤‘ê¸‰ ë ˆë²¨ (3.0 ì´ìƒ)</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-info-circle"></i>
                    <span id="detail-info">ì´ˆê¸‰ì í™˜ì˜! ì¦ê²ê²Œ ì°° ë¶„ë“¤ ì˜¤ì„¸ìš”.</span>
                </div>
            </div>

            <div class="detail-right-column">
                <div class="status-card">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    <!-- ìˆ«ì ì•ˆ ë³´ì´ê²Œ -->
                    <strong style="display:none;"><span id="current-players">4</span> / <span id="max-players">10</span> ëª…</strong>

                    <div class="participant-section">
                        <ul class="participant-list host-participant-list" id="host-participant-list"></ul>
                        <div class="participant-scroll">
                            <ul class="participant-list" id="participant-list"></ul>
                        </div>
                    </div>

                    <!-- ì¼ë°˜ ì°¸ê°€ììš© ë²„íŠ¼ -->
                    <button id="join-match-btn" class="login-button join-button" style="display:none;" onclick="handleJoin()">ì°¸ì—¬í•˜ê¸°</button>
                    <button id="cancel-match-btn" class="login-button join-button btn-cancel" style="display:none;">ì°¸ì—¬ ì·¨ì†Œ</button>

                    <!-- í˜¸ìŠ¤íŠ¸ìš© ë§ˆê° ë²„íŠ¼ -->
                    <button id="close-match-btn"
                            class="schedule-button join-button"
                            style="display:none; margin-top:8px;"
                            disabled>
                        ë§ˆê°í•˜ê¸°
                    </button>
                    <p id="host-select-hint" style="display:none;">
                        ì£¼ìµœìë¥¼ ì œì™¸í•˜ê³  ìµœëŒ€ 9ëª…ì„ ì²´í¬í•˜ë©´(ì£¼ìµœì í¬í•¨ 10ëª…) ë§ˆê° ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
                    </p>

                    <p id="login-prompt-msg" style="display:none; text-align: center; margin-top: 15px; font-size: 14px;">
                        ì°¸ì—¬í•˜ë ¤ë©´ <a href="/login" style="color: #6c5ce7; font-weight: 600;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- ê³µí†µ ë©”ë‰´ í† ê¸€ ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');
    const navChatLinkElement = document.getElementById('nav-chat-link-li');
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        if (!mainMenu.contains(event.target) && !menuToggle.contains(event.target) &&
            !profileMenu.contains(event.target) && !profileMenuToggle.contains(event.target)) {
            mainMenu.classList.remove('show');
            profileMenu.classList.remove('show');
        }
    });
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    // âœ… í—¤ë” ë‹‰ë„¤ì„ ë¡œë“œ (userNicknameì´ ìˆìœ¼ë©´ í—¤ë”ì— ë¿Œë ¤ì¤Œ)
    (function loadHeaderNickname() {
        const usernameSpan = document.getElementById('user-menu-username');
        if (usernameSpan) {
            usernameSpan.textContent = localStorage.getItem('userNickname') || 'ì‚¬ìš©ì';
        }
    })();

    function getMatchId() {
        const hidden = document.getElementById('match-id-hidden');
        return (hidden && hidden.value) ||
            new URLSearchParams(window.location.search).get("id") ||
            new URLSearchParams(window.location.search).get("matchId") ||
            window.location.pathname.split("/").pop();
    }

    function isMatchClosed() {
        const matchId = getMatchId();
        if (!matchId) return false;
        const matches = JSON.parse(localStorage.getItem("match_schedules")) || [];
        const found = matches.find(m => String(m.id) === String(matchId));
        return !!(found && found.status === "closed");
    }

    function loadMatchDetailFromLocal() {
        const matchId = getMatchId();
        if (!matchId) return;

        const matches = JSON.parse(localStorage.getItem('match_schedules')) || [];
        const match = matches.find(m => String(m.id) === String(matchId));
        if (!match) return;

        const datetimeSpan = document.getElementById('detail-datetime');
        const locationSpan = document.getElementById('detail-location');

        if (datetimeSpan && match.date && match.startTime && match.endTime) {
            try {
                const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                const d = new Date(match.date);
                const yoil = isNaN(d) ? '' : dayNames[d.getDay()];
                if (yoil) {
                    datetimeSpan.textContent = `${match.date} (${yoil}) ${match.startTime} ~ ${match.endTime}`;
                } else {
                    datetimeSpan.textContent = `${match.date} ${match.startTime} ~ ${match.endTime}`;
                }
            } catch (e) {
                datetimeSpan.textContent = `${match.date} ${match.startTime} ~ ${match.endTime}`;
            }
        }

        if (locationSpan && match.location) {
            locationSpan.textContent = match.location;
        }
    }

    function applyClosedUIIfNeeded() {
        if (!isMatchClosed()) return;

        const closeBtn = document.getElementById('close-match-btn');
        const joinBtn = document.getElementById('join-match-btn');
        const cancelBtn = document.getElementById('cancel-match-btn');

        if (closeBtn) {
            closeBtn.style.display = 'block';
            closeBtn.disabled = true;
            closeBtn.classList.remove('enabled');
            closeBtn.textContent = 'ë§ˆê° ì™„ë£Œ';
        }

        document.querySelectorAll('.player-select-checkbox').forEach(cb => {
            cb.disabled = true;
        });

        if (joinBtn) {
            joinBtn.disabled = true;
            joinBtn.textContent = 'ë§ˆê°ëœ ê²½ê¸°ì…ë‹ˆë‹¤';
        }
        if (cancelBtn) {
            cancelBtn.disabled = true;
        }

        const hostHint = document.getElementById('host-select-hint');
        if (hostHint) hostHint.style.display = 'none';
    }

    // --- ì°¸ì—¬ì/í˜¸ìŠ¤íŠ¸ ë”ë¯¸ ë°ì´í„° ---
    const MAX_PLAYERS = 10;

    // âœ… í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ (localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    const CURRENT_USER_ID = 999; // í”„ë¡ íŠ¸ ë°ëª¨ìš© ê³ ì • ID
    const CURRENT_USERNAME = localStorage.getItem('username') || 'my_user_id';
    const CURRENT_NICKNAME = localStorage.getItem('userNickname') || 'ì‚¬ìš©ì';

    // âœ… ë§¤ì¹˜ë³„ ì£¼ìµœì ë‹‰ë„¤ì„ ë§¤í•‘ (ëª©ë¡ MOCK_MATCHESì™€ ë™ì¼í•˜ê²Œ ë§ì¶”ê¸°)
    const MOCK_MATCH_HOSTS = [
        { matchId: 1, nickname: 'ìº¡í‹´ì†' },
        { matchId: 2, nickname: 'ìš´ì˜ì§„' },
        { matchId: 3, nickname: 'êµ¬ì›íˆ¬ìˆ˜' },
        { matchId: 4, nickname: 'í…ŒìŠ¤í„°' },
    ];

    const MOCK_PARTICIPANTS = [
        // âœ… ì—¬ê¸° í˜¸ìŠ¤íŠ¸ë¥¼ "í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì"ë¡œ ì„¤ì •
        {
            id: CURRENT_USER_ID,
            username: CURRENT_USERNAME,
            nickname: CURRENT_NICKNAME,
            position: 'ALA',
            role: 'Host'
        },
        { id: 101, username: 'captain_son',  nickname: 'ìº¡í‹´ì†',      position: 'ALA',      role: 'Player' },
        { id: 102, username: 'closer_kim',   nickname: 'êµ¬ì›íˆ¬ìˆ˜',    position: 'FIXO',     role: 'Player' },
        { id: 103, username: 'shootdori',    nickname: 'ìŠ›ëŒì´',      position: 'PIVO',     role: 'Player' },
        { id: 104, username: 'captain_park', nickname: 'ìº¡í‹´ë°•',      position: 'ALA',      role: 'Player' },
        { id: 105, username: 'futsal_mania', nickname: 'í’‹ì‚´ ë§¤ë‹ˆì•„', position: 'ALA',      role: 'Player' },
        { id: 106, username: 'keeper_p',     nickname: 'ê³¨í‚¤í¼p',     position: 'GOLEIRO',  role: 'Player' },
        { id: 107, username: 'keeper_k',     nickname: 'ê³¨í‚¤í¼K',     position: 'GOLEIRO',  role: 'Player' },
        { id: 108, username: 'pass_master',  nickname: 'íŒ¨ìŠ¤ë§ˆìŠ¤í„°',  position: 'FIXO',     role: 'Player' },
        { id: 109, username: 'power_shot',   nickname: 'íŒŒì›ŒìŠ›',      position: 'PIVO',     role: 'Player' }
    ];

    // âœ… í˜„ì¬ ë§¤ì¹˜ IDì— í•´ë‹¹í•˜ëŠ” Host ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
    function getHostNicknameForCurrentMatch() {
        const matchId = getMatchId();
        if (!matchId) return null;

        // 1) ë¡œì»¬ìŠ¤í† ë¦¬ì§€ match_schedules ì•ˆì—ì„œ nickname / host.nickname ìš°ì„  ì‚¬ìš©
        try {
            const matches = JSON.parse(localStorage.getItem('match_schedules') || '[]');
            const found = matches.find(m => String(m.id) === String(matchId));
            if (found) {
                if (found.nickname) return found.nickname;
                if (found.host && found.host.nickname) return found.host.nickname;
            }
        } catch (e) {
            console.error('match_schedules íŒŒì‹± ì˜¤ë¥˜:', e);
        }

        // 2) ì—†ìœ¼ë©´ ëª©ì—… ë§¤í•‘ì—ì„œ ì°¾ê¸°
        const staticHost = MOCK_MATCH_HOSTS.find(h => String(h.matchId) === String(matchId));
        return staticHost ? staticHost.nickname : null;
    }

    // âœ… ì°¸ì—¬ ì—¬ë¶€ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥/ì¡°íšŒ
    function getParticipationState() {
        const matchId = getMatchId();
        if (!matchId) return false;
        const map = JSON.parse(localStorage.getItem('match_participation') || '{}');
        return !!map[matchId];
    }

    function setParticipationState(joined) {
        const matchId = getMatchId();
        if (!matchId) return;
        const key = 'match_participation';
        const map = JSON.parse(localStorage.getItem(key) || '{}');
        if (joined) {
            map[matchId] = true;
        } else {
            delete map[matchId];
        }
        localStorage.setItem(key, JSON.stringify(map));
    }

    // ì‹¤ì œ í™”ë©´ì— ì‚¬ìš©í•  í˜„ì¬ ì°¸ê°€ì ëª©ë¡
    let currentParticipants = [];

    function buildInitialParticipants() {
        // âœ… ì´ ë§¤ì¹˜ì˜ ì£¼ìµœì ë‹‰ë„¤ì„
        const hostNickname = getHostNicknameForCurrentMatch();

        // ê¸°ë³¸: MOCK_PARTICIPANTSë¥¼ ë³µì‚¬í•˜ë©´ì„œ Hostì˜ nicknameë§Œ í˜„ì¬ ë§¤ì¹˜ì— ë§ê²Œ ë®ì–´ì“°ê¸°
        const baseList = MOCK_PARTICIPANTS.map(p => {
            if (p.role === 'Host' && hostNickname) {
                return { ...p, nickname: hostNickname };
            }
            return { ...p };
        });

        // ğŸ” í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € ì •ë³´
        const myMock = baseList.find(p => p.id === CURRENT_USER_ID);
        const iAmHost = !!myMock && myMock.role === 'Host';

        // âœ… í˜¸ìŠ¤íŠ¸ëŠ” ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°í•˜ì§€ ì•ŠìŒ
        if (iAmHost) {
            currentParticipants = baseList;
            isParticipating = true;   // í˜¸ìŠ¤íŠ¸ëŠ” ìë™ ì°¸ì—¬ ìƒíƒœ
        } else {
            currentParticipants = baseList.filter(p => p.id !== CURRENT_USER_ID);

            if (getParticipationState()) {
                if (myMock) currentParticipants.push(myMock);
                isParticipating = true;
            } else {
                isParticipating = false;
            }
        }
    }

    const selectedPlayerIds = new Set();

    function renderParticipantList() {
        const participants = currentParticipants;

        const listEl = document.getElementById('participant-list');
        const hostListEl = document.getElementById('host-participant-list');
        const currentPlayersEl = document.getElementById('current-players');
        const maxPlayersEl = document.getElementById('max-players');

        hostListEl.innerHTML = '';
        listEl.innerHTML = '';

        const me = participants.find(u => u.id === CURRENT_USER_ID);
        isParticipating = !!me;
        isHost = !!me && me.role === 'Host';

        const deleteBtn = document.getElementById('delete-match-btn');
        if (deleteBtn) {
            deleteBtn.style.display = isHost ? 'inline-block' : 'none';
        }

        const hostUser = participants.find(u => u.role === 'Host');
        const otherUsers = participants.filter(u => u.role !== 'Host');

        function createParticipantItem(user) {
            const listItem = document.createElement('li');

            const roleBadge = user.role === 'Host'
                ? `<span class="role-badge">ì£¼ìµœì</span>`
                : '';

            const nicknameDisplay = user.id === CURRENT_USER_ID
                ? `${user.nickname} (ë‚˜)`
                : `${user.nickname}`;

            const userIdDisplay = user.username ? ` (${user.username})` : '';

            let checkboxHtml = '';
            if (isHost && user.role !== 'Host') {
                checkboxHtml = `
                    <input type="checkbox"
                           class="player-select-checkbox"
                           data-user-id="${user.id}"
                           ${selectedPlayerIds.has(user.id) ? 'checked' : ''}>
                `;
            }

            listItem.innerHTML = `
                <div class="user-info">
                    <div class="user-main">
                        ${checkboxHtml}
                        <span>${nicknameDisplay}${userIdDisplay}</span>
                    </div>
                    ${roleBadge}
                </div>
                <div class="detail-info">
                    í¬ì§€ì…˜: ${user.position}
                </div>
            `;

            return listItem;
        }

        if (hostUser) {
            hostListEl.appendChild(createParticipantItem(hostUser));
        }

        otherUsers.forEach(user => {
            listEl.appendChild(createParticipantItem(user));
        });

        currentPlayersEl.textContent = participants.length;
        maxPlayersEl.textContent = MAX_PLAYERS.toString();

        const checkboxes = document.querySelectorAll('.player-select-checkbox');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', (e) => {
                const uid = parseInt(e.target.dataset.userId, 10);
                if (e.target.checked) {
                    selectedPlayerIds.add(uid);
                } else {
                    selectedPlayerIds.delete(uid);
                }
                updateCloseButtonState();
            });
        });

        updateJoinButtonState();
        updateCloseButtonState();
        applyClosedUIIfNeeded();
    }

    function updateJoinButtonState() {
        const joinBtn = document.getElementById('join-match-btn');
        const cancelBtn = document.getElementById('cancel-match-btn');
        const loginPrompt = document.getElementById('login-prompt-msg');
        const closeBtn = document.getElementById('close-match-btn');
        const hostHint = document.getElementById('host-select-hint');

        const isLoggedIn = localStorage.getItem('accessToken') !== null;

        if (!isLoggedIn) {
            joinBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            closeBtn.style.display = 'none';
            hostHint.style.display = 'none';
            loginPrompt.style.display = 'block';
            return;
        }

        loginPrompt.style.display = 'none';

        if (isHost) {
            joinBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            closeBtn.style.display = 'block';
            hostHint.style.display = 'block';
        } else {
            closeBtn.style.display = 'none';
            hostHint.style.display = 'none';

            if (isParticipating) {
                joinBtn.style.display = 'none';
                cancelBtn.style.display = 'block';
            } else {
                joinBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
            }
        }
    }

    function updateCloseButtonState() {
        const closeBtn = document.getElementById('close-match-btn');
        const hostHint = document.getElementById('host-select-hint');
        if (!closeBtn) return;

        if (isMatchClosed()) {
            applyClosedUIIfNeeded();
            return;
        }

        if (!isHost) {
            closeBtn.style.display = 'none';
            if (hostHint) hostHint.style.display = 'none';
            return;
        }

        const selectedCount = selectedPlayerIds.size;
        const totalSelectedIncludingHost = selectedCount + 1;

        closeBtn.style.display = 'block';
        if (hostHint) hostHint.style.display = 'block';

        if (totalSelectedIncludingHost >= MAX_PLAYERS) {
            closeBtn.disabled = false;
            closeBtn.classList.add('enabled');
            closeBtn.textContent = `ë§ˆê°í•˜ê¸° (ì„ ë°œ ì™„ë£Œ: ${totalSelectedIncludingHost}/${MAX_PLAYERS})`;
        } else {
            closeBtn.disabled = true;
            closeBtn.classList.remove('enabled');
            closeBtn.textContent = `ë§ˆê°í•˜ê¸° (í˜„ì¬ ì„ ë°œ: ${totalSelectedIncludingHost}/${MAX_PLAYERS})`;
        }
    }

    // âœ… ì°¸ì—¬í•˜ê¸°: ë‚˜ ì¶”ê°€ + ì°¸ì—¬ ì—¬ë¶€ ì €ì¥ + ìº˜ë¦°ë”ì— ê²½ê¸° ì¼ì • ì¶”ê°€
    function handleJoin() {
        if (isMatchClosed()) {
            alert("ì´ë¯¸ ë§ˆê°ëœ ê²½ê¸°ì…ë‹ˆë‹¤.");
            applyClosedUIIfNeeded();
            return;
        }

        if (isParticipating) {
            alert("ì´ë¯¸ ì´ ê²½ê¸°ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.");
            return;
        }

        if (confirm("ì •ë§ë¡œ ì´ ê²½ê¸°ì— ì°¸ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            alert("ì°¸ì—¬ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)");
            isParticipating = true;
            setParticipationState(true); // âœ… ì°¸ì—¬ ì—¬ë¶€ ì €ì¥

            const meFromMock = MOCK_PARTICIPANTS.find(p => p.id === CURRENT_USER_ID) || {
                id: CURRENT_USER_ID,
                username: 'my_user_id',
                nickname: 'ë‚˜ì˜ë‹‰ë„¤ì„',
                position: 'ALA',
                role: 'Player'
            };

            currentParticipants = currentParticipants.filter(p => p.id !== CURRENT_USER_ID);
            currentParticipants.push(meFromMock);

            renderParticipantList();

            // âœ… ìº˜ë¦°ë”(personalSchedules)ì— ì´ ê²½ê¸° ì¼ì • ì¶”ê°€
            const matchIdFromUrl = getMatchId();
            if (matchIdFromUrl) {
                let schedules = JSON.parse(localStorage.getItem("personalSchedules")) || [];

                // ì´ë¯¸ ë™ì¼ matchId ì¼ì •ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
                const already = schedules.some(
                    s => s.matchId && String(s.matchId) === String(matchIdFromUrl)
                );
                if (!already) {
                    const matches = JSON.parse(localStorage.getItem("match_schedules")) || [];
                    const match = matches.find(m => String(m.id) === String(matchIdFromUrl));

                    let dateStr = match?.date || null;
                    let startTime = match?.startTime || (match?.time ? match.time.split("~")[0].trim() : "");
                    let endTime = match?.endTime || (match?.time && match.time.includes("~") ? match.time.split("~")[1].trim() : "");
                    const locationText = match?.location || (document.getElementById('detail-location')?.textContent || "ê²½ê¸°");

                    if (!dateStr) {
                        const dtText = document.getElementById('detail-datetime')?.textContent || "";
                        const dateMatch = dtText.match(/(\d{4}-\d{2}-\d{2})/);
                        if (dateMatch) dateStr = dateMatch[1];
                        const timeMatch = dtText.match(/(\d{2}:\d{2})\s*~\s*(\d{2}:\d{2})/);
                        if (timeMatch) {
                            if (!startTime) startTime = timeMatch[1];
                            if (!endTime) endTime = timeMatch[2];
                        }
                    }

                    const scheduleObj = {
                        id: Date.now(),
                        type: 'match',
                        title: locationText || "ê²½ê¸° ì¼ì •",
                        detail: locationText || "",
                        matchId: matchIdFromUrl,
                        date: dateStr,
                        time: (startTime && endTime)
                            ? `${startTime} ~ ${endTime}`
                            : (match?.time || "")
                    };

                    schedules.push(scheduleObj);
                    localStorage.setItem("personalSchedules", JSON.stringify(schedules));
                    localStorage.setItem("calendarUpdated", "true");
                }
            }
        }
    }

    // âœ… ì°¸ì—¬ ì·¨ì†Œ: ë‚˜ ì œê±° + ì°¸ì—¬ ì—¬ë¶€ í•´ì œ
    function handleCancel() {
        if (isMatchClosed()) {
            alert("ì´ë¯¸ ë§ˆê°ëœ ê²½ê¸°ì…ë‹ˆë‹¤. ì°¸ì—¬ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
            applyClosedUIIfNeeded();
            return;
        }

        if (!isParticipating) {
            alert("ì´ë¯¸ ì´ ê²½ê¸°ì— ì°¸ì—¬í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        isParticipating = false;
        setParticipationState(false); // âœ… ì°¸ì—¬ ì—¬ë¶€ í•´ì œ

        currentParticipants = currentParticipants.filter(p => p.id !== CURRENT_USER_ID);
        renderParticipantList();
    }

    // âœ… ê²½ê¸° ì‚­ì œ: ë§¤ì¹˜ + ì¼ì • + ì°¸ì—¬ì •ë³´ + ì±„íŒ…ë°© ëª¨ë‘ ì œê±°
    function handleDeleteMatch() {
        if (!isHost) {
            alert("ì£¼ìµœìë§Œ ê²½ê¸°ë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm("âš ï¸ ì´ ê²½ê¸°ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë§¤ì¹˜ ëª©ë¡ / ìº˜ë¦°ë” / ì±„íŒ…ë°©ì—ì„œë„ ì‚¬ë¼ì§‘ë‹ˆë‹¤.)")) {
            return;
        }

        const matchId = getMatchId();

        if (matchId) {
            // 1) match_schedules ì—ì„œ ê²½ê¸° ì‚­ì œ
            let matches = JSON.parse(localStorage.getItem("match_schedules")) || [];
            matches = matches.filter(m => String(m.id) !== String(matchId));
            localStorage.setItem("match_schedules", JSON.stringify(matches));

            // 2) personalSchedules ì—ì„œ ì´ ë§¤ì¹˜ ì¼ì • ì‚­ì œ
            let schedules = JSON.parse(localStorage.getItem("personalSchedules")) || [];
            schedules = schedules.filter(
                s => !s.matchId || String(s.matchId) !== String(matchId)
            );
            localStorage.setItem("personalSchedules", JSON.stringify(schedules));

            // 3) ì°¸ì—¬ ì—¬ë¶€ ì •ë³´ ì‚­ì œ
            const map = JSON.parse(localStorage.getItem('match_participation') || '{}');
            delete map[matchId];
            localStorage.setItem('match_participation', JSON.stringify(map));

            // 4) ì´ ë§¤ì¹˜ì—ì„œ ë§Œë“¤ì–´ì§„ ì±„íŒ…ë°©ë„ ì‚­ì œ
            try {
                // (1) í˜¹ì‹œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆëŠ” ìƒì„± ìš”ì²­(clean)
                localStorage.removeItem('match_chat_request');

                // (2) chat_rooms_v1 ì—ì„œ fromMatchIdê°€ ì´ ê²½ê¸°ì¸ ë°© ì œê±°
                const roomStr = localStorage.getItem('chat_rooms_v1');
                if (roomStr) {
                    const roomsObj = JSON.parse(roomStr);

                    ['group', 'one-on-one'].forEach(type => {
                        if (Array.isArray(roomsObj[type])) {
                            roomsObj[type] = roomsObj[type].filter(
                                r => String(r.fromMatchId) !== String(matchId)
                            );
                        }
                    });

                    localStorage.setItem('chat_rooms_v1', JSON.stringify(roomsObj));
                }
            } catch (e) {
                console.error("ì±„íŒ…ë°© ì‚­ì œ ì¤‘ ì—ëŸ¬:", e);
            }

            // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ í”Œë˜ê·¸
            localStorage.setItem("calendarUpdated", "true");
        }

        alert("âœ… ê²½ê¸°ê°€ ì‚­ì œë˜ì—ˆê³ , ê´€ë ¨ ì±„íŒ…ë°©ë„ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");

        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = "/schedule";
        }
    }


    function handleCloseMatch() {
        if (!isHost) return;

        if (isMatchClosed()) {
            alert('ì´ë¯¸ ë§ˆê°ëœ ê²½ê¸°ì…ë‹ˆë‹¤.');
            applyClosedUIIfNeeded();
            return;
        }

        const selectedCount = selectedPlayerIds.size;
        const totalSelectedIncludingHost = selectedCount + 1;

        if (totalSelectedIncludingHost < MAX_PLAYERS) {
            alert(`ì•„ì§ ì„ ë°œ ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬ ${totalSelectedIncludingHost}/${MAX_PLAYERS})`);
            return;
        }

        const finalPlayers = currentParticipants
            .filter(p => p.role === 'Host' || selectedPlayerIds.has(p.id));

        const selectedNamesForConfirm = finalPlayers
            .map(p => p.nickname + (p.role === 'Host' ? ' (ì£¼ìµœì)' : ''))
            .join(', ');

        if (confirm(`ë‹¤ìŒ ì¸ì›ìœ¼ë¡œ ê²½ê¸°ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${selectedNamesForConfirm}`)) {

            const matchIdValue = getMatchId();

            // 1) match_schedules ìƒíƒœë¥¼ closedë¡œ
            if (matchIdValue) {
                let matches = JSON.parse(localStorage.getItem("match_schedules")) || [];
                matches.forEach(m => {
                    if (String(m.id) === String(matchIdValue)) {
                        m.status = "closed";
                    }
                });
                localStorage.setItem("match_schedules", JSON.stringify(matches));
            }

            // 2) ë§ˆê° ì‹œ, í˜„ì¬ ì‚¬ìš©ì(í˜¸ìŠ¤íŠ¸) ë§ˆì´í˜ì´ì§€ ìº˜ë¦°ë”ì— ì¼ì • ì¶”ê°€
            if (matchIdValue) {
                try {
                    let schedules = JSON.parse(localStorage.getItem("personalSchedules")) || [];
                    const already = schedules.some(
                        s => s.matchId && String(s.matchId) === String(matchIdValue)
                    );

                    if (!already) {
                        const matches = JSON.parse(localStorage.getItem("match_schedules")) || [];
                        const match = matches.find(m => String(m.id) === String(matchIdValue));

                        let dateStr    = match?.date || null;
                        let startTime  = match?.startTime || (match?.time ? match.time.split("~")[0].trim() : "");
                        let endTime    = match?.endTime   || (match?.time && match.time.includes("~") ? match.time.split("~")[1].trim() : "");
                        const locationFromMatch = match?.location;

                        const locationTextEl = document.getElementById('detail-location');
                        const datetimeTextEl = document.getElementById('detail-datetime');

                        const locationText = locationFromMatch || (locationTextEl ? locationTextEl.textContent : "ê²½ê¸°");
                        const datetimeText = datetimeTextEl ? datetimeTextEl.textContent : "";

                        if (!dateStr) {
                            const dateMatch = datetimeText.match(/(\d{4}-\d{2}-\d{2})/);
                            if (dateMatch) dateStr = dateMatch[1];
                            const timeMatch = datetimeText.match(/(\d{2}:\d{2})\s*~\s*(\d{2}:\d{2})/);
                            if (timeMatch) {
                                if (!startTime) startTime = timeMatch[1];
                                if (!endTime)   endTime   = timeMatch[2];
                            }
                        }

                        const scheduleObj = {
                            id: Date.now(),
                            type: 'match',
                            title: locationText || "ê²½ê¸° ì¼ì •",
                            detail: locationText || "",
                            matchId: matchIdValue,
                            date: dateStr,
                            time: (startTime && endTime)
                                ? `${startTime} ~ ${endTime}`
                                : (match?.time || "")
                        };

                        schedules.push(scheduleObj);
                        localStorage.setItem("personalSchedules", JSON.stringify(schedules));
                        localStorage.setItem("calendarUpdated", "true");
                    }
                } catch (e) {
                    console.error("ë§ˆê° ì‹œ ìº˜ë¦°ë” ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:", e);
                }
            }

            // 3) ì±„íŒ…ë°© ìš”ì²­ & ì´ë™
            const locationText2 = document.getElementById('detail-location')?.textContent || 'ê²½ê¸°';
            const datetimeText2 = document.getElementById('detail-datetime')?.textContent || '';

            const chatRoomRequest = {
                fromMatchId: matchIdValue || null,
                type: 'group',
                title: `ê²½ê¸° ì±„íŒ… - ${locationText2} ${datetimeText2}`,
                participants: finalPlayers.map(p => p.nickname),
                maxParticipants: MAX_PLAYERS
            };

            localStorage.setItem('match_chat_request', JSON.stringify(chatRoomRequest));

            alert('âœ… ê²½ê¸° ì¸ì›ì´ í™•ì •ë˜ì—ˆê³  ë§ˆê° ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ì œ ê²½ê¸° ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');

            window.location.href = "/chat";
        }
    }


    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');

        if (accessToken) {
            document.getElementById('profile-menu-toggle').style.display = 'block';
        }
        if (accessToken) {
            if (navLoginLink) navLoginLink.parentElement.style.display = 'none';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'list-item';
        } else {
            if (navLoginLink) navLoginLink.parentElement.style.display = 'list-item';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'none';
        }

        if (navChatLinkElement) {
            const chatLinkAnchor = navChatLinkElement.querySelector('a');
            if (chatLinkAnchor && !accessToken) {
                chatLinkAnchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    window.location.href = '/login';
                });
            }
        }

        const cancelButton = document.getElementById("cancel-match-btn");
        if (cancelButton) {
            cancelButton.addEventListener("click", () => {
                if (confirm("âš ï¸ ì •ë§ë¡œ ì´ ê²½ê¸° ì°¸ì—¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const matchIdFromUrl = getMatchId();

                    handleCancel(); // í™”ë©´ì—ì„œ ë‚˜ ì œê±° + ì°¸ì—¬ ìƒíƒœ í•´ì œ

                    // âœ… personalSchedules ì—ì„œ ì´ ê²½ê¸° ì¼ì • ì‚­ì œ
                    let schedules = JSON.parse(localStorage.getItem("personalSchedules")) || [];
                    schedules = schedules.filter(
                        (s) => !s.matchId || String(s.matchId) !== String(matchIdFromUrl)
                    );
                    localStorage.setItem("personalSchedules", JSON.stringify(schedules));

                    localStorage.setItem("calendarUpdated", "true");

                    alert("âœ… ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        const closeMatchBtn = document.getElementById('close-match-btn');
        if (closeMatchBtn) {
            closeMatchBtn.addEventListener('click', handleCloseMatch);
        }

        const deleteMatchBtn = document.getElementById('delete-match-btn');
        if (deleteMatchBtn) {
            deleteMatchBtn.addEventListener('click', handleDeleteMatch);
        }

        loadMatchDetailFromLocal();

        // âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€/ëª©ì—… ê¸°ë°˜ìœ¼ë¡œ ì²˜ìŒ ì°¸ê°€ì ìƒíƒœ êµ¬ì„± (ì—¬ê¸°ì„œ Host ë‹‰ë„¤ì„ ë§¤ì¹˜ë³„ë¡œ ë§ì¶°ì§)
        buildInitialParticipants();
        renderParticipantList();
    });
</script>



</body>
</html>
